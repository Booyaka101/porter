import{ah as ie,ai as ne,r as t,aj as le,j as e,ak as re,J as oe,al as ce,u as de,ab as ue,B as n,C as N,T as l,g as a,t as U,b as p,A as he,w as L,e as xe,f as me,m as V,P as J,D as q,x as G,y as _,k as j,a4 as pe,a5 as ge,a2 as be,n as fe}from"./index-DHdDvhkS.js";import{E as je}from"./Edit-DWaSqgqg.js";import{D as ye}from"./Delete-xPfzDSc5.js";import{G as M}from"./Grid-BJJzTr32.js";import{C as H}from"./Chip-CqU9Trdn.js";import{D as K}from"./DialogActions-CwLC6U3s.js";function Ce(c){return ie("MuiCardActions",c)}ne("MuiCardActions",["root","spacing"]);const ve=c=>{const{classes:d,disableSpacing:r}=c;return ce({root:["root",!r&&"spacing"]},Ce,d)},Se=re("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(c,d)=>{const{ownerState:r}=c;return[d.root,!r.disableSpacing&&d.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),ke=t.forwardRef(function(d,r){const m=le({props:d,name:"MuiCardActions"}),{disableSpacing:w=!1,className:g,...B}=m,y={...m,disableSpacing:w},A=ve(y);return e.jsx(Se,{className:oe(A.root,g),ownerState:y,ref:r,...B})}),Ee=()=>{const c=de(),[d]=ue(),r=d.get("machine"),[m,w]=t.useState([]),[g,B]=t.useState([]),[y,A]=t.useState(!0),[Q,T]=t.useState(!1),[C,I]=t.useState(null),[X,v]=t.useState(!1),[o,Y]=t.useState(null),[S,F]=t.useState(""),[u,$]=t.useState(""),[O,R]=t.useState({}),[W,b]=t.useState(""),[i,h]=t.useState({name:"",customer:"",pack:"",branch:""});t.useEffect(()=>{E()},[r]);const E=async()=>{try{const[s,x]=await Promise.all([fetch("/api/build-clients"),fetch("/api/machines")]),f=await s.json(),te=await x.json();w(f||[]);const k=(te||[]).filter(D=>D.tags?.includes("build")||D.tags?.includes("deploy"));B(k),r&&k.find(D=>D.id===r)?F(r):k.length>0&&F(k[0].id)}catch(s){b("Failed to load data: "+s.message)}finally{A(!1)}},z=(s=null)=>{s?(I(s),h({name:s.name,customer:s.customer,pack:s.pack,branch:s.branch})):(I(null),h({name:"",customer:"",pack:"",branch:""})),T(!0)},P=()=>{T(!1),I(null),h({name:"",customer:"",pack:"",branch:""})},Z=async()=>{try{const s=C?`/api/build-clients/${C.id}`:"/api/build-clients";if(!(await fetch(s,{method:C?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok)throw new Error("Failed to save");P(),E()}catch(s){b("Failed to save: "+s.message)}},ee=async s=>{if(window.confirm("Delete this build client?"))try{await fetch(`/api/build-clients/${s}`,{method:"DELETE"}),E()}catch(x){b("Failed to delete: "+x.message)}},se=s=>{Y(s),$(s.version||""),v(!0)},ae=async()=>{if(!(!S||!o)){R(s=>({...s,[o.id]:!0})),v(!1);try{const s=`--customer=${o.customer} --pack=${o.pack} --branch=${o.branch}${u?` --version=${u}`:""} --auto-install`,x=await fetch("/api/execute-script",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({script_path:"build-deploy/buildBundle.sh",machine_ids:[S],args:s})});if(!x.ok)throw new Error("Failed to trigger build");const f=await x.json();f.id&&c(`/build-output?id=${f.id}`)}catch(s){b("Failed to trigger build: "+s.message)}finally{R(s=>({...s,[o.id]:!1}))}}};return y?e.jsx(n,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(N,{})}):e.jsxs(n,{sx:{p:3},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(l,{variant:"h5",sx:{color:a.text.primary,display:"flex",alignItems:"center",gap:1},children:[e.jsx(U,{})," Build Clients"]}),e.jsx(p,{variant:"contained",startIcon:e.jsx(he,{}),onClick:()=>z(),sx:{bgcolor:a.primary},children:"Add Client"})]}),W&&e.jsx(L,{severity:"error",sx:{mb:2},onClose:()=>b(""),children:W}),g.length===0&&e.jsx(L,{severity:"warning",sx:{mb:2},children:'No build machines found. Add machines with "build" or "deploy" tags to enable 1-click builds.'}),e.jsxs(M,{container:!0,spacing:2,children:[m.map(s=>e.jsx(M,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(xe,{sx:{bgcolor:a.surface,border:`1px solid ${a.border}`,"&:hover":{borderColor:a.primary}},children:[e.jsxs(me,{children:[e.jsx(l,{variant:"h6",sx:{color:a.text.primary,mb:1},children:s.name}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsx(n,{sx:{display:"flex",gap:1},children:e.jsx(H,{label:`Customer: ${s.customer}`,size:"small"})}),e.jsx(n,{sx:{display:"flex",gap:1},children:e.jsx(H,{label:`Pack: ${s.pack}`,size:"small",variant:"outlined"})}),e.jsxs(l,{variant:"body2",sx:{color:a.text.muted,mt:1},children:["Branch: ",s.branch]})]})]}),e.jsxs(ke,{sx:{justifyContent:"space-between"},children:[e.jsxs(n,{children:[e.jsx(V,{size:"small",onClick:()=>z(s),children:e.jsx(je,{fontSize:"small"})}),e.jsx(V,{size:"small",onClick:()=>ee(s.id),color:"error",children:e.jsx(ye,{fontSize:"small"})})]}),e.jsx(p,{variant:"contained",size:"small",startIcon:O[s.id]?e.jsx(N,{size:16}):e.jsx(J,{}),onClick:()=>se(s),disabled:O[s.id]||g.length===0,sx:{bgcolor:a.success},children:"Build"})]})]})},s.id)),m.length===0&&e.jsx(M,{item:!0,xs:12,children:e.jsxs(n,{sx:{textAlign:"center",py:6,color:a.text.muted,border:`2px dashed ${a.border}`,borderRadius:2},children:[e.jsx(U,{sx:{fontSize:48,mb:2,opacity:.5}}),e.jsx(l,{children:"No build clients configured"}),e.jsx(l,{variant:"body2",children:'Click "Add Client" to create your first build configuration'})]})})]}),e.jsxs(q,{open:Q,onClose:P,maxWidth:"sm",fullWidth:!0,children:[e.jsx(G,{children:C?"Edit Build Client":"Add Build Client"}),e.jsx(_,{children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(j,{label:"Name",value:i.name,onChange:s=>h({...i,name:s.target.value}),fullWidth:!0,placeholder:"e.g., Inspire Production"}),e.jsx(j,{label:"Customer",value:i.customer,onChange:s=>h({...i,customer:s.target.value}),fullWidth:!0,placeholder:"e.g., inspire"}),e.jsx(j,{label:"Pack",value:i.pack,onChange:s=>h({...i,pack:s.target.value}),fullWidth:!0,placeholder:"e.g., inspire"}),e.jsx(j,{label:"Branch",value:i.branch,onChange:s=>h({...i,branch:s.target.value}),fullWidth:!0,placeholder:"e.g., customer/inspire-xtrend"})]})}),e.jsxs(K,{children:[e.jsx(p,{onClick:P,children:"Cancel"}),e.jsx(p,{onClick:Z,variant:"contained",disabled:!i.name||!i.customer||!i.branch,children:"Save"})]})]}),e.jsxs(q,{open:X,onClose:()=>v(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(G,{children:["Trigger Build: ",o?.name]}),e.jsx(_,{children:e.jsxs(n,{sx:{mt:2},children:[e.jsxs(pe,{fullWidth:!0,children:[e.jsx(ge,{children:"Build Machine"}),e.jsx(be,{value:S,onChange:s=>F(s.target.value),label:"Build Machine",children:g.map(s=>e.jsxs(fe,{value:s.id,children:[s.name," (",s.host,")"]},s.id))})]}),e.jsx(j,{label:"Version",value:u,onChange:s=>$(s.target.value),fullWidth:!0,placeholder:"e.g., 1.2.3",sx:{mt:2},required:!0,error:!u,helperText:u?"":"Version is required for the build"}),e.jsxs(n,{sx:{mt:2,p:2,bgcolor:a.background,borderRadius:1},children:[e.jsx(l,{variant:"body2",sx:{color:a.text.muted,mb:1},children:"Build will run with:"}),e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace"},children:["--customer=",o?.customer]}),e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace"},children:["--pack=",o?.pack]}),e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace"},children:["--branch=",o?.branch]}),u&&e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace",color:a.primary},children:["--version=",u]}),e.jsx(l,{variant:"body2",sx:{fontFamily:"monospace",color:a.success},children:"--auto-install"})]})]})}),e.jsxs(K,{children:[e.jsx(p,{onClick:()=>v(!1),children:"Cancel"}),e.jsx(p,{onClick:ae,variant:"contained",startIcon:e.jsx(J,{}),disabled:!S||!u,sx:{bgcolor:a.success},children:"Start Build"})]})]})]})};export{Ee as default};
