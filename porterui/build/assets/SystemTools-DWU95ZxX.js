import{r as o,j as e,B as l,T as i,a4 as B,a5 as L,a2 as G,n as y,m as z,R as Pe,p as q,C as Q,X as I,k as m,I as De,S as Te,b as r,A as Y,l as Z,e as U,f as W,D as P,x as D,y as T}from"./index-DfzNkgux.js";import{I as Ae,S as Re,U as ze,a as Ue,B as We}from"./Shield-DlGL5xe4.js";import{D as J}from"./Delete-CUPdazwc.js";import{C as Fe}from"./CheckCircle-7Rf20H3U.js";import{P as Ne,A as $e}from"./AdminPanelSettings-C57oN20U.js";import{G as Oe}from"./Group-CTq-gveH.js";import{P as Ee}from"./PowerSettingsNew-hzXvJSBo.js";import{R as He}from"./RestartAlt-CKx7_lil.js";import{D as M}from"./Dns-C0QGz-LT.js";import{T as Be,a as F}from"./Tab-z5FgWICa.js";import{T as N,a as V,b as d,c as n,d as $}from"./TableRow-BYmGTLOU.js";import{C as _}from"./Chip-CJRM8HuN.js";import{G as w}from"./Grid-BzAoS5fi.js";import{S as Le}from"./Switch-BIMoQtcX.js";import{D as A}from"./DialogActions-BlQbCahF.js";import{L as Ge}from"./LinearProgress-CslxzD4E.js";import"./SwitchBase-CQk5bgul.js";const rs=()=>{const[ee,se]=o.useState([]),[t,ne]=o.useState(""),[S,ae]=o.useState(0),[O,K]=o.useState(!1),[X,le]=o.useState(""),[te,oe]=o.useState([]),[x,g]=o.useState({open:!1,packageName:"",installing:!1}),[C,v]=o.useState({open:!1,upgrading:!1,output:""}),[f,re]=o.useState({enabled:!1,rules:[]}),[p,u]=o.useState({open:!1,port:"",action:"allow",protocol:"tcp"}),[ie,ce]=o.useState([]),[h,j]=o.useState({open:!1,username:"",password:"",groups:"",shell:"/bin/bash"}),[b,de]=o.useState(null),[R,k]=o.useState({open:!1,hostname:""});o.useEffect(()=>{fetch("/api/machines").then(s=>s.json()).then(s=>se(s||[])).catch(console.error)},[]);const c=o.useCallback(async()=>{if(t){K(!0);try{const[s,a,H,Se]=await Promise.all([fetch(`/api/machines/${t}/packages`),fetch(`/api/machines/${t}/firewall`),fetch(`/api/machines/${t}/users`),fetch(`/api/machines/${t}/system`)]),[Ce,ve,ke,Ie]=await Promise.all([s.json(),a.json(),H.json(),Se.json()]);oe(Ce.packages||[]),re(ve),ce(ke.users||[]),de(Ie)}catch(s){console.error("Failed to load system data:",s)}finally{K(!1)}}},[t]);o.useEffect(()=>{t&&c()},[t,c]);const he=async()=>{if(x.packageName.trim()){g(s=>({...s,installing:!0}));try{await fetch(`/api/machines/${t}/packages/install`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({packages:x.packageName.split(/\s+/)})}),g({open:!1,packageName:"",installing:!1}),c()}catch(s){console.error("Install failed:",s),g(a=>({...a,installing:!1}))}}},xe=async s=>{if(window.confirm(`Remove package "${s}"?`))try{await fetch(`/api/machines/${t}/packages/remove`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({packages:[s]})}),c()}catch(a){console.error("Remove failed:",a)}},pe=async()=>{v({open:!0,upgrading:!0,output:"Updating package lists..."});try{const a=await(await fetch(`/api/machines/${t}/packages/upgrade`,{method:"POST"})).json();v(H=>({...H,upgrading:!1,output:a.output||"Upgrade complete!"})),c()}catch(s){v(a=>({...a,upgrading:!1,output:"Upgrade failed: "+s.message}))}},je=async()=>{try{await fetch(`/api/machines/${t}/firewall/${f.enabled?"disable":"enable"}`,{method:"POST"}),c()}catch(s){console.error("Firewall toggle failed:",s)}},me=async()=>{if(p.port.trim())try{await fetch(`/api/machines/${t}/firewall/rule`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({port:p.port,action:p.action,protocol:p.protocol})}),u({open:!1,port:"",action:"allow",protocol:"tcp"}),c()}catch(s){console.error("Add rule failed:",s)}},ge=async s=>{if(window.confirm(`Delete firewall rule for port ${s.port}?`))try{await fetch(`/api/machines/${t}/firewall/rule`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({port:s.port,action:s.action})}),c()}catch(a){console.error("Delete rule failed:",a)}},fe=async()=>{if(h.username.trim())try{await fetch(`/api/machines/${t}/users`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:h.username,password:h.password,groups:h.groups,shell:h.shell})}),j({open:!1,username:"",password:"",groups:"",shell:"/bin/bash"}),c()}catch(s){console.error("Add user failed:",s)}},ue=async s=>{if(window.confirm(`Delete user "${s}"? This cannot be undone.`))try{await fetch(`/api/machines/${t}/users/${s}`,{method:"DELETE"}),c()}catch(a){console.error("Delete user failed:",a)}},be=async()=>{if(R.hostname.trim())try{await fetch(`/api/machines/${t}/hostname`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hostname:R.hostname})}),k({open:!1,hostname:""}),c()}catch(s){console.error("Set hostname failed:",s)}},ye=async()=>{if(window.confirm("Are you sure you want to reboot this machine?"))try{await fetch(`/api/machines/${t}/reboot`,{method:"POST"})}catch(s){console.error("Reboot failed:",s)}},we=async()=>{if(window.confirm("Are you sure you want to shutdown this machine?"))try{await fetch(`/api/machines/${t}/shutdown`,{method:"POST"})}catch(s){console.error("Shutdown failed:",s)}},E=te.filter(s=>s.name?.toLowerCase().includes(X.toLowerCase()));return e.jsxs(l,{children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:3},children:[e.jsx(i,{variant:"h4",sx:{fontWeight:700},children:"System Tools"}),e.jsxs(l,{sx:{display:"flex",gap:2},children:[e.jsxs(B,{size:"small",sx:{minWidth:200},children:[e.jsx(L,{children:"Machine"}),e.jsx(G,{value:t,onChange:s=>ne(s.target.value),label:"Machine",children:ee.map(s=>e.jsx(y,{value:s.id,children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(l,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:s.status==="online"?"#22c55e":"#ff3366"}}),s.name]})},s.id))})]}),e.jsx(z,{onClick:c,disabled:!t||O,children:e.jsx(Pe,{sx:{color:O?"grey":"#f97316"}})})]})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs(Be,{value:S,onChange:(s,a)=>ae(a),sx:{mb:3},children:[e.jsx(F,{label:"Packages",icon:e.jsx(Ae,{}),iconPosition:"start"}),e.jsx(F,{label:"Firewall",icon:e.jsx(Re,{}),iconPosition:"start"}),e.jsx(F,{label:"Users",icon:e.jsx(q,{}),iconPosition:"start"}),e.jsx(F,{label:"System",icon:e.jsx(M,{}),iconPosition:"start"})]}),O?e.jsx(l,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(Q,{})}):e.jsxs(e.Fragment,{children:[S===0&&e.jsxs(l,{children:[e.jsx(I,{sx:{p:2,mb:3},children:e.jsxs(l,{sx:{display:"flex",gap:2,alignItems:"center"},children:[e.jsx(m,{size:"small",placeholder:"Search packages...",value:X,onChange:s=>le(s.target.value),InputProps:{startAdornment:e.jsx(De,{position:"start",children:e.jsx(Te,{sx:{color:"rgba(255,255,255,0.5)"}})})},sx:{minWidth:250}}),e.jsx(l,{sx:{flex:1}}),e.jsx(r,{startIcon:e.jsx(Y,{}),variant:"outlined",onClick:()=>g({open:!0,packageName:"",installing:!1}),children:"Install Package"}),e.jsx(r,{startIcon:e.jsx(ze,{}),variant:"contained",onClick:pe,children:"Upgrade All"})]})}),e.jsxs(I,{sx:{overflow:"hidden"},children:[e.jsxs(N,{size:"small",children:[e.jsx(V,{children:e.jsxs(d,{sx:{bgcolor:"rgba(0,212,255,0.05)"},children:[e.jsx(n,{sx:{fontWeight:600},children:"Package"}),e.jsx(n,{sx:{fontWeight:600},children:"Version"}),e.jsx(n,{sx:{fontWeight:600},children:"Status"}),e.jsx(n,{sx:{fontWeight:600,textAlign:"right"},children:"Actions"})]})}),e.jsx($,{children:E.slice(0,100).map(s=>e.jsxs(d,{sx:{"&:hover":{bgcolor:"rgba(0,212,255,0.03)"}},children:[e.jsx(n,{children:e.jsx(i,{sx:{fontFamily:"monospace",fontSize:"0.85rem"},children:s.name})}),e.jsx(n,{children:e.jsx(i,{variant:"body2",color:"text.secondary",children:s.version})}),e.jsx(n,{children:e.jsx(_,{label:s.status||"installed",size:"small",color:"success",sx:{fontSize:"0.7rem"}})}),e.jsx(n,{children:e.jsx(l,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(Z,{title:"Remove",children:e.jsx(z,{size:"small",onClick:()=>xe(s.name),children:e.jsx(J,{sx:{fontSize:18,color:"#ff3366"}})})})})})]},s.name))})]}),E.length>100&&e.jsx(l,{sx:{p:2,textAlign:"center"},children:e.jsxs(i,{variant:"body2",color:"text.secondary",children:["Showing 100 of ",E.length," packages. Use search to filter."]})})]})]}),S===1&&e.jsx(l,{children:e.jsxs(w,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(w,{item:!0,xs:12,md:4,children:e.jsx(U,{sx:{background:f.enabled?"linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,212,255,0.05) 100%)":"linear-gradient(135deg, rgba(255,51,102,0.1) 0%, rgba(255,170,0,0.05) 100%)"},children:e.jsx(W,{children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ue,{sx:{fontSize:40,color:f.enabled?"#22c55e":"#ff3366"}}),e.jsxs(l,{children:[e.jsx(i,{variant:"h6",children:"Firewall"}),e.jsx(i,{variant:"body2",color:"text.secondary",children:f.enabled?"Active & Protected":"Disabled"})]})]}),e.jsx(Le,{checked:f.enabled,onChange:je,color:"success"})]})})})}),e.jsx(w,{item:!0,xs:12,md:8,children:e.jsx(U,{children:e.jsxs(W,{children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsx(i,{variant:"h6",children:"Firewall Rules"}),e.jsx(r,{startIcon:e.jsx(Y,{}),size:"small",onClick:()=>u({open:!0,port:"",action:"allow",protocol:"tcp"}),children:"Add Rule"})]}),f.rules?.length>0?e.jsxs(N,{size:"small",children:[e.jsx(V,{children:e.jsxs(d,{children:[e.jsx(n,{children:"Port"}),e.jsx(n,{children:"Action"}),e.jsx(n,{children:"Protocol"}),e.jsx(n,{})]})}),e.jsx($,{children:f.rules.map((s,a)=>e.jsxs(d,{children:[e.jsx(n,{sx:{fontFamily:"monospace"},children:s.port}),e.jsx(n,{children:e.jsx(_,{label:s.action,size:"small",color:s.action==="allow"?"success":"error",icon:s.action==="allow"?e.jsx(Fe,{}):e.jsx(We,{})})}),e.jsx(n,{children:s.protocol||"tcp"}),e.jsx(n,{children:e.jsx(z,{size:"small",onClick:()=>ge(s),children:e.jsx(J,{sx:{fontSize:16}})})})]},a))})]}):e.jsx(i,{variant:"body2",color:"text.secondary",children:"No rules configured"})]})})})]})}),S===2&&e.jsxs(l,{children:[e.jsx(I,{sx:{p:2,mb:3},children:e.jsxs(l,{sx:{display:"flex",gap:2,alignItems:"center"},children:[e.jsxs(i,{variant:"subtitle1",sx:{fontWeight:600},children:[e.jsx(Oe,{sx:{mr:1,verticalAlign:"middle"}}),"System Users"]}),e.jsx(l,{sx:{flex:1}}),e.jsx(r,{startIcon:e.jsx(Ne,{}),variant:"contained",onClick:()=>j({open:!0,username:"",password:"",groups:"",shell:"/bin/bash"}),children:"Add User"})]})}),e.jsx(I,{sx:{overflow:"hidden"},children:e.jsxs(N,{size:"small",children:[e.jsx(V,{children:e.jsxs(d,{sx:{bgcolor:"rgba(0,212,255,0.05)"},children:[e.jsx(n,{sx:{fontWeight:600},children:"Username"}),e.jsx(n,{sx:{fontWeight:600},children:"UID"}),e.jsx(n,{sx:{fontWeight:600},children:"Groups"}),e.jsx(n,{sx:{fontWeight:600},children:"Shell"}),e.jsx(n,{sx:{fontWeight:600},children:"Home"}),e.jsx(n,{sx:{fontWeight:600,textAlign:"right"},children:"Actions"})]})}),e.jsx($,{children:ie.map(s=>e.jsxs(d,{sx:{"&:hover":{bgcolor:"rgba(0,212,255,0.03)"}},children:[e.jsx(n,{children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.uid===0?e.jsx($e,{sx:{color:"#ff3366",fontSize:18}}):e.jsx(q,{sx:{color:"#f97316",fontSize:18}}),e.jsx(i,{sx:{fontFamily:"monospace",fontSize:"0.85rem"},children:s.username})]})}),e.jsx(n,{children:s.uid}),e.jsx(n,{children:e.jsx(i,{variant:"body2",color:"text.secondary",sx:{maxWidth:200,overflow:"hidden",textOverflow:"ellipsis"},children:s.groups||"-"})}),e.jsx(n,{sx:{fontFamily:"monospace",fontSize:"0.8rem"},children:s.shell}),e.jsx(n,{sx:{fontFamily:"monospace",fontSize:"0.8rem"},children:s.home}),e.jsx(n,{children:e.jsx(l,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(Z,{title:"Delete User",children:e.jsx(z,{size:"small",onClick:()=>ue(s.username),disabled:s.uid===0,children:e.jsx(J,{sx:{fontSize:18,color:s.uid===0?"grey":"#ff3366"}})})})})})]},s.username))})]})})]}),S===3&&b&&e.jsx(l,{children:e.jsxs(w,{container:!0,spacing:3,children:[e.jsx(w,{item:!0,xs:12,md:6,children:e.jsx(U,{children:e.jsxs(W,{children:[e.jsx(i,{variant:"h6",sx:{mb:2},children:"System Information"}),e.jsx(N,{size:"small",children:e.jsxs($,{children:[e.jsxs(d,{children:[e.jsx(n,{sx:{fontWeight:600,border:0},children:"Hostname"}),e.jsx(n,{sx:{border:0},children:b.hostname})]}),e.jsxs(d,{children:[e.jsx(n,{sx:{fontWeight:600,border:0},children:"OS"}),e.jsx(n,{sx:{border:0},children:b.os})]}),e.jsxs(d,{children:[e.jsx(n,{sx:{fontWeight:600,border:0},children:"Kernel"}),e.jsx(n,{sx:{border:0},children:b.kernel})]}),e.jsxs(d,{children:[e.jsx(n,{sx:{fontWeight:600,border:0},children:"Uptime"}),e.jsx(n,{sx:{border:0},children:b.uptime})]}),e.jsxs(d,{children:[e.jsx(n,{sx:{fontWeight:600,border:0},children:"Architecture"}),e.jsx(n,{sx:{border:0},children:b.arch})]})]})})]})})}),e.jsx(w,{item:!0,xs:12,md:6,children:e.jsx(U,{children:e.jsxs(W,{children:[e.jsx(i,{variant:"h6",sx:{mb:2},children:"System Actions"}),e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(r,{variant:"outlined",startIcon:e.jsx(M,{}),onClick:()=>k({open:!0,hostname:b.hostname}),children:"Change Hostname"}),e.jsx(r,{variant:"outlined",color:"warning",startIcon:e.jsx(He,{}),onClick:ye,children:"Reboot System"}),e.jsx(r,{variant:"outlined",color:"error",startIcon:e.jsx(Ee,{}),onClick:we,children:"Shutdown System"})]})]})})})]})})]})]}),!t&&e.jsxs(I,{sx:{p:6,textAlign:"center"},children:[e.jsx(M,{sx:{fontSize:64,color:"rgba(255,255,255,0.1)",mb:2}}),e.jsx(i,{color:"text.secondary",children:"Select a machine to manage system tools"})]}),e.jsxs(P,{open:x.open,onClose:()=>!x.installing&&g({open:!1,packageName:"",installing:!1}),children:[e.jsx(D,{children:"Install Package"}),e.jsx(T,{children:e.jsx(m,{autoFocus:!0,fullWidth:!0,label:"Package Name(s)",value:x.packageName,onChange:s=>g(a=>({...a,packageName:s.target.value})),placeholder:"e.g., nginx htop vim",helperText:"Separate multiple packages with spaces",sx:{mt:1},disabled:x.installing})}),e.jsxs(A,{children:[e.jsx(r,{onClick:()=>g({open:!1,packageName:"",installing:!1}),disabled:x.installing,children:"Cancel"}),e.jsx(r,{variant:"contained",onClick:he,disabled:x.installing,children:x.installing?e.jsx(Q,{size:20}):"Install"})]})]}),e.jsxs(P,{open:C.open,onClose:()=>!C.upgrading&&v({open:!1,upgrading:!1,output:""}),children:[e.jsx(D,{children:"System Upgrade"}),e.jsxs(T,{sx:{minWidth:400},children:[C.upgrading&&e.jsx(Ge,{sx:{mb:2}}),e.jsx(l,{sx:{bgcolor:"#0d1117",p:2,borderRadius:1,fontFamily:"monospace",fontSize:"0.8rem",maxHeight:300,overflow:"auto",whiteSpace:"pre-wrap",color:"#e0f7ff"},children:C.output})]}),e.jsx(A,{children:e.jsx(r,{onClick:()=>v({open:!1,upgrading:!1,output:""}),disabled:C.upgrading,children:"Close"})})]}),e.jsxs(P,{open:p.open,onClose:()=>u({open:!1,port:"",action:"allow",protocol:"tcp"}),children:[e.jsx(D,{children:"Add Firewall Rule"}),e.jsx(T,{children:e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(m,{label:"Port",value:p.port,onChange:s=>u(a=>({...a,port:s.target.value})),placeholder:"e.g., 80, 443, 8080"}),e.jsxs(B,{children:[e.jsx(L,{children:"Action"}),e.jsxs(G,{value:p.action,onChange:s=>u(a=>({...a,action:s.target.value})),label:"Action",children:[e.jsx(y,{value:"allow",children:"Allow"}),e.jsx(y,{value:"deny",children:"Deny"})]})]}),e.jsxs(B,{children:[e.jsx(L,{children:"Protocol"}),e.jsxs(G,{value:p.protocol,onChange:s=>u(a=>({...a,protocol:s.target.value})),label:"Protocol",children:[e.jsx(y,{value:"tcp",children:"TCP"}),e.jsx(y,{value:"udp",children:"UDP"}),e.jsx(y,{value:"both",children:"Both"})]})]})]})}),e.jsxs(A,{children:[e.jsx(r,{onClick:()=>u({open:!1,port:"",action:"allow",protocol:"tcp"}),children:"Cancel"}),e.jsx(r,{variant:"contained",onClick:me,children:"Add Rule"})]})]}),e.jsxs(P,{open:h.open,onClose:()=>j({open:!1,username:"",password:"",groups:"",shell:"/bin/bash"}),children:[e.jsx(D,{children:"Add User"}),e.jsx(T,{children:e.jsxs(l,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1,minWidth:350},children:[e.jsx(m,{label:"Username",value:h.username,onChange:s=>j(a=>({...a,username:s.target.value}))}),e.jsx(m,{label:"Password",type:"password",value:h.password,onChange:s=>j(a=>({...a,password:s.target.value}))}),e.jsx(m,{label:"Groups",value:h.groups,onChange:s=>j(a=>({...a,groups:s.target.value})),placeholder:"e.g., sudo,docker",helperText:"Comma-separated list of groups"}),e.jsx(m,{label:"Shell",value:h.shell,onChange:s=>j(a=>({...a,shell:s.target.value}))})]})}),e.jsxs(A,{children:[e.jsx(r,{onClick:()=>j({open:!1,username:"",password:"",groups:"",shell:"/bin/bash"}),children:"Cancel"}),e.jsx(r,{variant:"contained",onClick:fe,children:"Create User"})]})]}),e.jsxs(P,{open:R.open,onClose:()=>k({open:!1,hostname:""}),children:[e.jsx(D,{children:"Change Hostname"}),e.jsx(T,{children:e.jsx(m,{autoFocus:!0,fullWidth:!0,label:"New Hostname",value:R.hostname,onChange:s=>k(a=>({...a,hostname:s.target.value})),sx:{mt:1}})}),e.jsxs(A,{children:[e.jsx(r,{onClick:()=>k({open:!1,hostname:""}),children:"Cancel"}),e.jsx(r,{variant:"contained",onClick:be,children:"Change"})]})]})]})};export{rs as default};
