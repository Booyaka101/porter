import{c as W,j as e,u as Ie,a as we,r as i,B as t,s as Re,g as r,ac as q,T as n,H as K,G as Q,l as v,m as j,b as u,M as ve,n as d,R as De,k as Ee,I as Le,S as Me,a4 as Y,a2 as Z,a1 as ee,e as Fe,f as se,d as Te,h as _e,af as Ae,D as re,x as te,y as oe}from"./index-DfzNkgux.js";import{C as ne}from"./CheckCircle-7Rf20H3U.js";import{E as We}from"./ExpandLess-CpMA8qS_.js";import{D as Pe}from"./Delete-CUPdazwc.js";import{A as $e}from"./AccessTime-CRZ8DyPd.js";import{T as He}from"./TrendingUp-Cow4i_wG.js";import{D as Oe}from"./Download-YToDSxE_.js";import{T as Be}from"./Timeline-CfOtm3-Z.js";import{C as ae}from"./Checkbox-BoCqbxlk.js";import{C as A}from"./Chip-CJRM8HuN.js";import{C as Ve}from"./Collapse-B627qha0.js";import{L as Ne}from"./LinearProgress-CslxzD4E.js";import{P as Je}from"./Pagination-DFd69_Y7.js";import{D as ie}from"./DialogActions-BlQbCahF.js";import"./SwitchBase-CQk5bgul.js";const Ue=W(e.jsx("path",{d:"M10 18h4v-2h-4zM3 6v2h18V6zm3 7h12v-2H6z"})),D=W(e.jsx("path",{d:"M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8"})),Ge=W(e.jsx("path",{d:"M3 14h4v-4H3zm0 5h4v-4H3zM3 9h4V5H3zm5 5h13v-4H8zm0 5h13v-4H8zM8 5v4h13V5z"})),cs=()=>{const P=Ie(),{isAdmin:$}=we(),[E,le]=i.useState([]),[m,ce]=i.useState(null),[H,O]=i.useState(!0),[b,de]=i.useState(""),[L,xe]=i.useState(null),[M,f]=i.useState(1),[y,ue]=i.useState(20),[S,he]=i.useState("all"),[B,k]=i.useState(null),[x,C]=i.useState(null),[z,V]=i.useState("list"),[c,I]=i.useState([]),[F,T]=i.useState({open:!1,executions:[]}),[h,N]=i.useState({}),[pe,J]=i.useState(null),w=i.useCallback(async()=>{O(!0);try{const[s,o]=await Promise.all([fetch("/api/history?limit=100"),fetch("/api/history/stats")]),a=await s.json(),l=await o.json();le(a||[]),ce(l),N({})}catch(s){console.error("Failed to load history:",s)}O(!1)},[]),ge=i.useCallback(async s=>{if(!h[s]){J(s);try{const o=await fetch(`/api/history/${s}`);if(o.ok){const a=await o.json();N(l=>({...l,[s]:a}))}}catch(o){console.error("Failed to load execution detail:",o)}J(null)}},[h]),U=s=>{C(s)},me=()=>{x&&P(`/scripts?rerun=${x.id}`),C(null)};i.useEffect(()=>{w()},[w]);const be=async()=>{if(window.confirm("Clear all execution history?"))try{await fetch("/api/history",{method:"DELETE"}),w()}catch(s){console.error("Failed to clear history:",s)}},g=E.filter(s=>{const o=s.machine_name?.toLowerCase().includes(b.toLowerCase())||s.script_name?.toLowerCase().includes(b.toLowerCase())||s.script_path?.toLowerCase().includes(b.toLowerCase()),a=S==="all"||S==="success"&&s.success||S==="failed"&&!s.success;return o&&a}),G=Math.ceil(g.length/y),p=g.slice((M-1)*y,M*y),je=s=>s?s.replace("s"," sec").replace("m"," min "):"-",fe=()=>{const s=JSON.stringify(g,null,2);X(s,"execution-history.json","application/json"),k(null)},ye=()=>{const s=["ID","Machine","Script","Status","Started","Duration","Error"],o=g.map(l=>[l.id,l.machine_name,l.script_name||l.script_path,l.success?"Success":"Failed",new Date(l.started_at).toISOString(),l.duration||"",l.error||""]),a=[s,...o].map(l=>l.map(R=>`"${String(R).replace(/"/g,'""')}"`).join(",")).join(`
`);X(a,"execution-history.csv","text/csv"),k(null)},X=(s,o,a)=>{const l=new Blob([s],{type:a}),R=URL.createObjectURL(l),_=document.createElement("a");_.href=R,_.download=o,_.click(),URL.revokeObjectURL(R)},Se=s=>{I(o=>o.includes(s)?o.filter(a=>a!==s):[...o,s])},ke=()=>{c.length===p.length?I([]):I(p.map(s=>s.id))},Ce=()=>{if(c.length===0)return;const s=E.filter(o=>c.includes(o.id));s.length===1?U(s[0]):P(`/scripts?rerun=${s[0].id}`)},ze=()=>{if(c.length!==2)return;const s=E.filter(o=>c.includes(o.id));T({open:!0,executions:s})};return g.reduce((s,o)=>{const a=new Date(o.started_at).toLocaleDateString();return s[a]||(s[a]=[]),s[a].push(o),s},{}),e.jsxs(t,{sx:Re.pageContainer,children:[e.jsx(t,{sx:{background:q.header,borderRadius:"24px",border:`1px solid ${r.border.light}`,p:3,mb:4},children:e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:2},children:[e.jsxs(t,{children:[e.jsx(n,{sx:{fontSize:"2.2rem",fontWeight:800,background:q.text,backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",letterSpacing:"-0.02em",mb:.5},children:"Execution History"}),e.jsx(n,{sx:{color:r.text.muted,fontSize:"0.95rem"},children:"View past script executions and their results"}),m&&e.jsxs(t,{sx:{display:"flex",gap:3,mt:2},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(K,{sx:{fontSize:16,color:r.primary}}),e.jsxs(n,{sx:{color:r.text.secondary,fontSize:"0.85rem"},children:[e.jsx("strong",{style:{color:r.primary},children:m.total})," Total"]})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ne,{sx:{fontSize:16,color:r.secondary}}),e.jsxs(n,{sx:{color:r.text.secondary,fontSize:"0.85rem"},children:[e.jsx("strong",{style:{color:r.secondary},children:m.successful})," Success"]})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Q,{sx:{fontSize:16,color:r.error}}),e.jsxs(n,{sx:{color:r.text.secondary,fontSize:"0.85rem"},children:[e.jsx("strong",{style:{color:r.error},children:m.failed})," Failed"]})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(He,{sx:{fontSize:16,color:r.warning}}),e.jsxs(n,{sx:{color:r.text.secondary,fontSize:"0.85rem"},children:[e.jsxs("strong",{style:{color:r.warning},children:[m.success_rate?.toFixed(1),"%"]})," Rate"]})]})]})]}),e.jsxs(t,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(t,{sx:{display:"flex",background:"rgba(255,255,255,0.03)",borderRadius:"10px",border:`1px solid ${r.border.light}`,p:.5},children:[e.jsx(v,{title:"List View",children:e.jsx(j,{size:"small",onClick:()=>V("list"),sx:{color:z==="list"?r.primary:r.text.muted,background:z==="list"?"rgba(249, 115, 22, 0.15)":"transparent",borderRadius:"8px","&:hover":{background:"rgba(249, 115, 22, 0.1)"}},children:e.jsx(Ge,{})})}),e.jsx(v,{title:"Timeline View",children:e.jsx(j,{size:"small",onClick:()=>V("timeline"),sx:{color:z==="timeline"?r.primary:r.text.muted,background:z==="timeline"?"rgba(249, 115, 22, 0.15)":"transparent",borderRadius:"8px","&:hover":{background:"rgba(249, 115, 22, 0.1)"}},children:e.jsx(Be,{})})})]}),e.jsx(u,{startIcon:e.jsx(Oe,{}),onClick:s=>k(s.currentTarget),sx:{color:r.text.secondary,textTransform:"none",background:"rgba(255,255,255,0.03)",borderRadius:"10px","&:hover":{background:"rgba(249, 115, 22, 0.1)"}},children:"Export"}),e.jsxs(ve,{anchorEl:B,open:!!B,onClose:()=>k(null),PaperProps:{sx:{background:"rgba(17, 24, 39, 0.95)",backdropFilter:"blur(20px)",border:`1px solid ${r.border.light}`,borderRadius:"12px"}},children:[e.jsx(d,{onClick:fe,children:"Export as JSON"}),e.jsx(d,{onClick:ye,children:"Export as CSV"})]}),e.jsx(v,{title:"Refresh",children:e.jsx(j,{onClick:w,sx:{color:r.text.muted,background:"rgba(255,255,255,0.03)","&:hover":{color:r.primary,background:"rgba(249, 115, 22, 0.1)"}},children:e.jsx(De,{})})}),e.jsx(u,{onClick:be,startIcon:e.jsx(Pe,{}),size:"small",sx:{color:r.text.muted,textTransform:"none",background:"rgba(255,255,255,0.03)",borderRadius:"10px",px:2,"&:hover":{color:r.error,background:"rgba(255, 68, 102, 0.1)"}},children:"Clear All"})]})]})}),e.jsxs(t,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(Ee,{size:"small",placeholder:"Search by machine or script...",value:b,onChange:s=>{de(s.target.value),f(1)},InputProps:{startAdornment:e.jsx(Le,{position:"start",children:e.jsx(Me,{sx:{color:r.text.disabled}})})},sx:{flex:1,minWidth:200,"& .MuiOutlinedInput-root":{background:r.background.glass,borderRadius:"12px"}}}),e.jsx(Y,{size:"small",sx:{minWidth:120},children:e.jsxs(Z,{value:S,onChange:s=>{he(s.target.value),f(1)},startAdornment:e.jsx(Ue,{sx:{mr:1,color:r.text.disabled}}),sx:{background:r.background.glass,borderRadius:"12px","& .MuiOutlinedInput-notchedOutline":{borderColor:r.border.light}},children:[e.jsx(d,{value:"all",children:"All Status"}),e.jsx(d,{value:"success",children:"Success"}),e.jsx(d,{value:"failed",children:"Failed"})]})}),e.jsx(Y,{size:"small",sx:{minWidth:100},children:e.jsxs(Z,{value:y,onChange:s=>{ue(s.target.value),f(1)},sx:{background:r.background.glass,borderRadius:"12px","& .MuiOutlinedInput-notchedOutline":{borderColor:r.border.light}},children:[e.jsx(d,{value:10,children:"10 / page"}),e.jsx(d,{value:20,children:"20 / page"}),e.jsx(d,{value:50,children:"50 / page"}),e.jsx(d,{value:100,children:"100 / page"})]})})]}),c.length>0&&e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2,mb:2,p:2,background:"linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%)",borderRadius:"12px",border:"1px solid rgba(249, 115, 22, 0.3)"},children:[e.jsx(ae,{checked:c.length===p.length,indeterminate:c.length>0&&c.length<p.length,onChange:ke,sx:{color:r.primary,"&.Mui-checked":{color:r.primary}}}),e.jsxs(n,{sx:{color:r.primary,fontWeight:600},children:[c.length," selected"]}),e.jsx(t,{sx:{flex:1}}),$()&&e.jsx(u,{size:"small",startIcon:e.jsx(D,{}),onClick:Ce,sx:{color:r.primary,textTransform:"none","&:hover":{background:"rgba(249, 115, 22, 0.15)"}},children:"Re-run Selected"}),c.length===2&&e.jsx(u,{size:"small",startIcon:e.jsx(ee,{}),onClick:ze,sx:{color:"#06b6d4",textTransform:"none","&:hover":{background:"rgba(6, 182, 212, 0.15)"}},children:"Compare Outputs"}),e.jsx(u,{size:"small",onClick:()=>I([]),sx:{color:r.text.muted,textTransform:"none"},children:"Clear"})]}),!H&&e.jsxs(n,{sx:{color:r.text.disabled,fontSize:"0.85rem",mb:2},children:["Showing ",p.length," of ",g.length," executions"]}),H?e.jsx(t,{children:[1,2,3,4,5].map(s=>e.jsxs(t,{sx:{mb:2,p:2,background:r.background.glass,borderRadius:"12px",border:`1px solid ${r.border.light}`,borderLeft:`4px solid ${r.border.light}`},children:[e.jsxs(t,{sx:{display:"flex",gap:2,mb:1},children:[e.jsx(t,{sx:{width:120,height:20,background:"rgba(255,255,255,0.05)",borderRadius:1}}),e.jsx(t,{sx:{width:60,height:20,background:"rgba(255,255,255,0.05)",borderRadius:1}})]}),e.jsx(t,{sx:{width:200,height:16,background:"rgba(255,255,255,0.03)",borderRadius:1,mb:1}}),e.jsx(t,{sx:{width:150,height:14,background:"rgba(255,255,255,0.02)",borderRadius:1}})]},s))}):p.length===0?e.jsxs(t,{sx:{textAlign:"center",py:8,background:r.background.glass,borderRadius:"16px",border:`1px solid ${r.border.light}`},children:[e.jsx(K,{sx:{fontSize:64,color:r.text.disabled,mb:2}}),e.jsx(n,{sx:{color:r.text.muted},children:b?"No matching executions found":"No execution history yet"}),e.jsx(n,{sx:{color:r.text.disabled,fontSize:"0.85rem"},children:"Run a script to see it appear here"})]}):p.map((s,o)=>e.jsxs(Fe,{sx:{mb:1.5,background:o%2===0?"rgba(255,255,255,0.02)":"rgba(255,255,255,0.04)",borderRadius:"12px",border:`1px solid ${r.border.light}`,borderLeft:`4px solid ${s.success?r.secondary:r.error}`,transition:"all 0.25s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{borderColor:s.success?r.secondary:r.error,background:s.success?"rgba(34, 197, 94, 0.05)":"rgba(255, 68, 102, 0.05)",transform:"translateX(4px)",boxShadow:`0 4px 20px ${s.success?"rgba(34, 197, 94, 0.15)":"rgba(255, 68, 102, 0.15)"}`}},children:[e.jsx(se,{sx:{pb:1},children:e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"flex-start",gap:1,flex:1},children:[e.jsx(ae,{size:"small",checked:c.includes(s.id),onChange:()=>Se(s.id),sx:{mt:-.5,color:r.text.muted,"&.Mui-checked":{color:r.primary}}}),e.jsxs(t,{sx:{flex:1},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Te,{sx:{fontSize:18,color:r.primary}}),e.jsx(n,{sx:{color:r.text.primary,fontWeight:600},children:s.machine_name}),e.jsx(A,{icon:s.success?e.jsx(ne,{}):e.jsx(Q,{}),label:s.success?"Success":"Failed",size:"small",sx:{background:s.success?"rgba(34, 197, 94, 0.1)":"rgba(255, 68, 102, 0.1)",color:s.success?r.secondary:r.error,"& .MuiChip-icon":{color:s.success?r.secondary:r.error}}})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(_e,{sx:{fontSize:16,color:r.text.disabled}}),e.jsx(n,{sx:{color:r.text.secondary,fontSize:"0.9rem"},children:s.script_name||s.script_path}),s.preset_name&&e.jsx(A,{label:s.preset_name,size:"small",sx:{height:20,fontSize:"0.7rem"}})]}),e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(n,{sx:{color:r.text.disabled,fontSize:"0.8rem",display:"flex",alignItems:"center",gap:.5},children:[e.jsx($e,{sx:{fontSize:14}}),new Date(s.started_at).toLocaleString()]}),s.duration&&e.jsxs(n,{sx:{color:r.text.disabled,fontSize:"0.8rem"},children:["Duration: ",je(s.duration)]})]})]})]}),e.jsxs(t,{sx:{display:"flex",gap:.5},children:[$()&&e.jsx(v,{title:"Re-run this execution",children:e.jsx(j,{size:"small",onClick:()=>U(s),sx:{color:r.text.muted,"&:hover":{color:r.primary,background:"rgba(249, 115, 22, 0.1)"}},children:e.jsx(D,{})})}),e.jsx(j,{size:"small",onClick:()=>{const a=L===s.id?null:s.id;xe(a),a&&ge(s.id)},sx:{color:r.text.secondary},children:L===s.id?e.jsx(We,{}):e.jsx(Ae,{})})]})]})}),e.jsx(Ve,{in:L===s.id,children:e.jsx(se,{sx:{pt:0},children:pe===s.id?e.jsxs(t,{sx:{py:2},children:[e.jsx(Ne,{sx:{borderRadius:1}}),e.jsx(n,{sx:{color:r.text.muted,fontSize:"0.85rem",mt:1,textAlign:"center"},children:"Loading output..."})]}):e.jsxs(e.Fragment,{children:[(h[s.id]?.error||s.error)&&e.jsxs(t,{sx:{background:"rgba(255, 68, 102, 0.1)",borderRadius:"8px",p:2,mb:2},children:[e.jsx(n,{sx:{color:r.error,fontWeight:600,fontSize:"0.85rem",mb:.5},children:"Error"}),e.jsx(n,{sx:{color:r.text.secondary,fontSize:"0.85rem"},children:h[s.id]?.error||s.error})]}),h[s.id]?.output?e.jsxs(t,{sx:{background:"rgba(0,0,0,0.3)",borderRadius:"8px",p:2,maxHeight:300,overflow:"auto"},children:[e.jsx(n,{sx:{color:r.text.muted,fontWeight:600,fontSize:"0.85rem",mb:1},children:"Output"}),e.jsx("pre",{style:{margin:0,color:r.text.secondary,fontSize:"0.8rem",fontFamily:'"JetBrains Mono", monospace',whiteSpace:"pre-wrap",wordBreak:"break-word"},children:h[s.id].output})]}):h[s.id]?e.jsx(n,{sx:{color:r.text.muted,fontSize:"0.85rem",fontStyle:"italic"},children:"No output recorded"}):null]})})})]},s.id)),G>1&&e.jsx(t,{sx:{display:"flex",justifyContent:"center",mt:3,pb:2},children:e.jsx(Je,{count:G,page:M,onChange:(s,o)=>f(o),color:"primary",sx:{"& .MuiPaginationItem-root":{color:r.text.secondary,"&.Mui-selected":{background:"rgba(249, 115, 22, 0.2)",color:r.primary}}}})}),e.jsxs(re,{open:!!x,onClose:()=>C(null),PaperProps:{sx:{background:"rgba(17, 24, 39, 0.95)",backdropFilter:"blur(20px)",border:`1px solid ${r.border.light}`,borderRadius:"16px",minWidth:400}},children:[e.jsxs(te,{sx:{color:r.text.primary,display:"flex",alignItems:"center",gap:1},children:[e.jsx(D,{sx:{color:r.primary}}),"Confirm Re-run"]}),e.jsx(oe,{children:x&&e.jsxs(t,{children:[e.jsx(n,{sx:{color:r.text.secondary,mb:2},children:"Are you sure you want to re-run this execution?"}),e.jsxs(t,{sx:{background:"rgba(255,255,255,0.03)",borderRadius:"8px",p:2,border:`1px solid ${r.border.light}`},children:[e.jsx(n,{sx:{color:r.text.primary,fontWeight:600,mb:.5},children:x.script_name}),e.jsxs(n,{sx:{color:r.text.muted,fontSize:"0.85rem"},children:["Machine: ",x.machine_name]}),x.args&&e.jsxs(n,{sx:{color:r.text.disabled,fontSize:"0.8rem",mt:.5,fontFamily:"monospace"},children:["Args: ",x.args]})]})]})}),e.jsxs(ie,{sx:{p:2,pt:0},children:[e.jsx(u,{onClick:()=>C(null),sx:{color:r.text.secondary},children:"Cancel"}),e.jsx(u,{onClick:me,variant:"contained",startIcon:e.jsx(D,{}),sx:{background:"linear-gradient(135deg, #f97316 0%, #ea580c 100%)","&:hover":{background:"linear-gradient(135deg, #fb923c 0%, #f97316 100%)"}},children:"Re-run"})]})]}),e.jsxs(re,{open:F.open,onClose:()=>T({open:!1,executions:[]}),maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{background:"rgba(17, 24, 39, 0.95)",backdropFilter:"blur(20px)",border:`1px solid ${r.border.light}`,borderRadius:"16px",maxHeight:"80vh"}},children:[e.jsxs(te,{sx:{color:r.text.primary,display:"flex",alignItems:"center",gap:1},children:[e.jsx(ee,{sx:{color:"#06b6d4"}}),"Compare Execution Outputs"]}),e.jsx(oe,{children:F.executions.length===2&&e.jsx(t,{sx:{display:"flex",gap:2},children:F.executions.map((s,o)=>e.jsxs(t,{sx:{flex:1},children:[e.jsxs(t,{sx:{p:2,mb:2,background:s.success?"rgba(34, 197, 94, 0.1)":"rgba(255, 68, 102, 0.1)",borderRadius:"8px",border:`1px solid ${s.success?"rgba(34, 197, 94, 0.3)":"rgba(255, 68, 102, 0.3)"}`},children:[e.jsx(n,{sx:{color:r.text.primary,fontWeight:600,fontSize:"0.9rem"},children:s.script_name}),e.jsxs(n,{sx:{color:r.text.muted,fontSize:"0.8rem"},children:[s.machine_name," â€¢ ",new Date(s.started_at).toLocaleString()]}),e.jsx(A,{label:s.success?"Success":"Failed",size:"small",sx:{mt:1,background:s.success?"rgba(34, 197, 94, 0.2)":"rgba(255, 68, 102, 0.2)",color:s.success?r.secondary:r.error}})]}),e.jsxs(t,{sx:{background:"rgba(0,0,0,0.3)",borderRadius:"8px",p:2,maxHeight:400,overflow:"auto"},children:[e.jsxs(n,{sx:{color:r.text.muted,fontWeight:600,fontSize:"0.8rem",mb:1},children:["Output ",o+1]}),e.jsx("pre",{style:{margin:0,color:r.text.secondary,fontSize:"0.75rem",fontFamily:'"JetBrains Mono", monospace',whiteSpace:"pre-wrap",wordBreak:"break-word"},children:s.output||"(No output)"}),s.error&&e.jsx(t,{sx:{mt:2,p:1,background:"rgba(255, 68, 102, 0.1)",borderRadius:"4px"},children:e.jsxs(n,{sx:{color:r.error,fontSize:"0.75rem"},children:["Error: ",s.error]})})]})]},s.id))})}),e.jsx(ie,{sx:{p:2,pt:0},children:e.jsx(u,{onClick:()=>T({open:!1,executions:[]}),sx:{color:r.text.secondary},children:"Close"})})]})]})};export{cs as default};
