import{r as a,j as e,B as h,T as d,a4 as Se,a5 as Ie,a2 as Fe,n as w,X as U,m as W,Y as le,R as ze,Z as X,b as r,_ as Me,$ as ie,C as q,q as re,M as Re,L as T,a0 as Te,o as N,D as b,x as D,y as k,k as Y,h as Ne,i as Le}from"./index-BR8HzIu-.js";import{C as Pe,D as Be,L as Ee,a as $e,A as Ue,I as We,T as Oe}from"./Link-CJTzGLFV.js";import{A as Ae}from"./ArrowBack-fMblk9rH.js";import{U as He,M as Ve}from"./MoreVert-CGpmXEBB.js";import{D as Je}from"./Download-FYTa3SsS.js";import{D as ce}from"./Delete-DwUrccAH.js";import{E as de}from"./Edit-BSjMYvVA.js";import{S as Ke}from"./Save-Dlv0N-to.js";import{T as Xe,a as qe,b as G,c,d as Ye}from"./TableRow-BgXj_boL.js";import{C as Ge}from"./Chip-CiJfAjDW.js";import{D as L}from"./DialogActions-BOBerqwj.js";import{L as Ze}from"./LinearProgress-W34AkTm_.js";const ds=()=>{const[he,xe]=a.useState([]),[i,pe]=a.useState(""),[x,O]=a.useState("/home"),[Z,fe]=a.useState([]),[A,_]=a.useState(!1),[v,P]=a.useState([]),[j,H]=a.useState("name"),[u,V]=a.useState("asc"),[S,C]=a.useState({open:!1,file:null,content:"",loading:!1}),[p,f]=a.useState({open:!1,file:null,content:"",saving:!1}),[B,I]=a.useState({open:!1,name:""}),[J,F]=a.useState({open:!1,uploading:!1,progress:0}),[E,z]=a.useState({open:!1,files:[]}),[M,R]=a.useState({open:!1,file:null,newName:""}),[t,g]=a.useState({open:!1,x:0,y:0,file:null}),Q=a.useRef(null);a.useEffect(()=>{fetch("/api/machines").then(s=>s.json()).then(s=>xe(s||[])).catch(console.error)},[]);const m=a.useCallback(async()=>{if(i){_(!0),P([]);try{const n=await(await fetch(`/api/machines/${i}/files?path=${encodeURIComponent(x)}`)).json();fe(n.files||[])}catch(s){console.error("Failed to load files:",s)}finally{_(!1)}}},[i,x]);a.useEffect(()=>{i&&m()},[i,x,m]);const $=s=>{O(s)},me=()=>{const s=x.split("/").filter(Boolean);s.pop(),O("/"+s.join("/")||"/")},je=s=>{s.isDir&&$(s.path)},ue=s=>{s.isDir||ee(s)},ee=async s=>{C({open:!0,file:s,content:"",loading:!0});try{const o=await(await fetch(`/api/machines/${i}/file?path=${encodeURIComponent(s.path)}`)).json();C(l=>({...l,content:o.content||"",loading:!1}))}catch(n){C(o=>({...o,content:"Failed to load file: "+n.message,loading:!1}))}},se=async s=>{f({open:!0,file:s,content:"",saving:!1});try{const o=await(await fetch(`/api/machines/${i}/file?path=${encodeURIComponent(s.path)}`)).json();f(l=>({...l,content:o.content||""}))}catch{f(o=>({...o,content:""}))}},ge=async()=>{f(s=>({...s,saving:!0}));try{await fetch(`/api/machines/${i}/file`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:p.file.path,content:p.content})}),f({open:!1,file:null,content:"",saving:!1}),m()}catch(s){console.error("Failed to save file:",s),f(n=>({...n,saving:!1}))}},ne=async()=>{if(B.name.trim())try{await fetch(`/api/machines/${i}/mkdir`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:`${x}/${B.name}`})}),I({open:!1,name:""}),m()}catch(s){console.error("Failed to create folder:",s)}},ye=async s=>{const n=s.target.files[0];if(!n)return;F({open:!0,uploading:!0,progress:0});const o=new FormData;o.append("file",n),o.append("path",x);try{const l=new XMLHttpRequest;l.upload.onprogress=y=>{y.lengthComputable&&F(ve=>({...ve,progress:y.loaded/y.total*100}))},l.onload=()=>{F({open:!1,uploading:!1,progress:0}),m()},l.onerror=()=>{F({open:!1,uploading:!1,progress:0})},l.open("POST",`/api/machines/${i}/upload`),l.send(o)}catch(l){console.error("Upload failed:",l),F({open:!1,uploading:!1,progress:0})}s.target.value=""},Ce=async s=>{try{const o=await(await fetch(`/api/machines/${i}/download?path=${encodeURIComponent(s.path)}`)).blob(),l=URL.createObjectURL(o),y=document.createElement("a");y.href=l,y.download=s.name,y.click(),URL.revokeObjectURL(l)}catch(n){console.error("Download failed:",n)}},we=async()=>{try{for(const s of E.files)await fetch(`/api/machines/${i}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:s.path,recursive:s.isDir})});z({open:!1,files:[]}),P([]),m()}catch(s){console.error("Delete failed:",s)}},oe=async()=>{if(M.newName.trim())try{const s=x+"/"+M.newName;await fetch(`/api/machines/${i}/rename`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPath:M.file.path,newPath:s})}),R({open:!1,file:null,newName:""}),m()}catch(s){console.error("Rename failed:",s)}},ae=(s,n)=>{s.preventDefault(),g({open:!0,x:s.clientX,y:s.clientY,file:n})},be=s=>{if(s.isDir)return e.jsx(re,{sx:{color:"#ffaa00"}});if(s.isSymlink)return e.jsx(Ee,{sx:{color:"#f97316"}});switch(s.name.split(".").pop()?.toLowerCase()){case"txt":case"md":case"log":return e.jsx(Oe,{sx:{color:"#7dd3fc"}});case"jpg":case"jpeg":case"png":case"gif":case"svg":return e.jsx(We,{sx:{color:"#ff00ff"}});case"js":case"ts":case"py":case"go":case"rs":case"java":case"c":case"cpp":case"h":return e.jsx(Le,{sx:{color:"#22c55e"}});case"sh":case"bash":return e.jsx(Ne,{sx:{color:"#ffaa00"}});case"zip":case"tar":case"gz":case"rar":return e.jsx(Ue,{sx:{color:"#ff6b6b"}});default:return e.jsx($e,{sx:{color:"rgba(255,255,255,0.5)"}})}},De=s=>{if(s==null)return"-";if(s===0)return"0 B";const n=["B","KB","MB","GB","TB"],o=Math.floor(Math.log(s)/Math.log(1024));return`${(s/Math.pow(1024,o)).toFixed(1)} ${n[o]}`},ke=s=>s?new Date(s).toLocaleString():"-",te=[...Z].sort((s,n)=>{if(s.isDir&&!n.isDir)return-1;if(!s.isDir&&n.isDir)return 1;let o=0;switch(j){case"name":o=s.name.localeCompare(n.name);break;case"size":o=(s.size||0)-(n.size||0);break;case"modified":o=new Date(s.modified||0)-new Date(n.modified||0);break;default:o=0}return u==="asc"?o:-o}),K=x.split("/").filter(Boolean);return e.jsxs(h,{children:[e.jsxs(h,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:3},children:[e.jsx(d,{variant:"h4",sx:{fontWeight:700},children:"File Manager"}),e.jsxs(Se,{size:"small",sx:{minWidth:200},children:[e.jsx(Ie,{children:"Machine"}),e.jsx(Fe,{value:i,onChange:s=>{pe(s.target.value),O("/home")},label:"Machine",children:he.map(s=>e.jsx(w,{value:s.id,children:e.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(h,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:s.status==="online"?"#22c55e":"#ff3366"}}),s.name]})},s.id))})]})]}),i&&e.jsxs(e.Fragment,{children:[e.jsx(U,{sx:{p:2,mb:2},children:e.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(W,{onClick:me,disabled:x==="/",children:e.jsx(Ae,{})}),e.jsx(W,{onClick:()=>$("/home"),children:e.jsx(le,{})}),e.jsx(W,{onClick:m,disabled:A,children:e.jsx(ze,{sx:{color:A?"grey":"#f97316"}})}),e.jsx(X,{orientation:"vertical",flexItem:!0,sx:{mx:1}}),e.jsx(r,{startIcon:e.jsx(Pe,{}),onClick:()=>I({open:!0,name:""}),size:"small",children:"New Folder"}),e.jsx(r,{startIcon:e.jsx(He,{}),onClick:()=>Q.current?.click(),size:"small",children:"Upload"}),e.jsx("input",{type:"file",ref:Q,onChange:ye,style:{display:"none"}}),v.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(X,{orientation:"vertical",flexItem:!0,sx:{mx:1}}),e.jsxs(r,{startIcon:e.jsx(ce,{}),color:"error",onClick:()=>z({open:!0,files:v}),size:"small",children:["Delete (",v.length,")"]})]}),e.jsx(h,{sx:{flex:1}}),e.jsxs(d,{variant:"body2",color:"text.secondary",children:[Z.length," items"]})]})}),e.jsx(U,{sx:{p:1.5,mb:2},children:e.jsxs(Me,{children:[e.jsxs(ie,{component:"button",onClick:()=>$("/"),sx:{display:"flex",alignItems:"center",gap:.5,cursor:"pointer"},children:[e.jsx(le,{sx:{fontSize:18}})," root"]}),K.map((s,n)=>{const o="/"+K.slice(0,n+1).join("/");return n===K.length-1?e.jsx(d,{color:"text.primary",sx:{fontWeight:500},children:s},o):e.jsx(ie,{component:"button",onClick:()=>$(o),sx:{cursor:"pointer"},children:s},o)})]})}),A?e.jsx(h,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(q,{})}):e.jsx(U,{sx:{overflow:"hidden"},children:e.jsxs(Xe,{size:"small",children:[e.jsx(qe,{children:e.jsxs(G,{sx:{bgcolor:"rgba(0,212,255,0.05)"},children:[e.jsx(c,{padding:"checkbox",sx:{width:40}}),e.jsxs(c,{sx:{fontWeight:600,cursor:"pointer"},onClick:()=>{H("name"),V(j==="name"&&u==="asc"?"desc":"asc")},children:["Name ",j==="name"&&(u==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{fontWeight:600,cursor:"pointer",width:100},onClick:()=>{H("size"),V(j==="size"&&u==="asc"?"desc":"asc")},children:["Size ",j==="size"&&(u==="asc"?"↑":"↓")]}),e.jsx(c,{sx:{fontWeight:600,width:100},children:"Permissions"}),e.jsxs(c,{sx:{fontWeight:600,cursor:"pointer",width:180},onClick:()=>{H("modified"),V(j==="modified"&&u==="asc"?"desc":"asc")},children:["Modified ",j==="modified"&&(u==="asc"?"↑":"↓")]}),e.jsx(c,{sx:{width:50}})]})}),e.jsxs(Ye,{children:[te.map(s=>e.jsxs(G,{selected:v.some(n=>n.path===s.path),onClick:()=>je(s),onDoubleClick:()=>ue(s),onContextMenu:n=>ae(n,s),sx:{cursor:"pointer","&:hover":{bgcolor:"rgba(0,212,255,0.05)"},"&.Mui-selected":{bgcolor:"rgba(0,212,255,0.1)"}},children:[e.jsx(c,{padding:"checkbox",children:e.jsx("input",{type:"checkbox",checked:v.some(n=>n.path===s.path),onChange:n=>{n.stopPropagation(),n.target.checked?P(o=>[...o,s]):P(o=>o.filter(l=>l.path!==s.path))},onClick:n=>n.stopPropagation()})}),e.jsx(c,{children:e.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:1},children:[be(s),e.jsx(d,{sx:{fontFamily:"monospace",fontSize:"0.85rem"},children:s.name}),s.isSymlink&&e.jsx(Ge,{label:"symlink",size:"small",sx:{fontSize:"0.65rem",height:18}})]})}),e.jsx(c,{children:e.jsx(d,{variant:"body2",color:"text.secondary",children:s.isDir?"-":De(s.size)})}),e.jsx(c,{children:e.jsx(d,{sx:{fontFamily:"monospace",fontSize:"0.75rem",color:"text.secondary"},children:s.permissions||"-"})}),e.jsx(c,{children:e.jsx(d,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.8rem"},children:ke(s.modified)})}),e.jsx(c,{children:e.jsx(W,{size:"small",onClick:n=>{n.stopPropagation(),ae(n,s)},children:e.jsx(Ve,{sx:{fontSize:18}})})})]},s.path)),te.length===0&&e.jsx(G,{children:e.jsx(c,{colSpan:6,sx:{textAlign:"center",py:4},children:e.jsx(d,{color:"text.secondary",children:"Empty directory"})})})]})]})})]}),!i&&e.jsxs(U,{sx:{p:6,textAlign:"center"},children:[e.jsx(re,{sx:{fontSize:64,color:"rgba(255,255,255,0.1)",mb:2}}),e.jsx(d,{color:"text.secondary",children:"Select a machine to browse files"})]}),e.jsxs(Re,{open:t.open,onClose:()=>g({...t,open:!1}),anchorReference:"anchorPosition",anchorPosition:{top:t.y,left:t.x},children:[!t.file?.isDir&&e.jsxs(w,{onClick:()=>{ee(t.file),g({...t,open:!1})},children:[e.jsx(T,{children:e.jsx(Te,{fontSize:"small"})}),e.jsx(N,{children:"View"})]}),!t.file?.isDir&&e.jsxs(w,{onClick:()=>{se(t.file),g({...t,open:!1})},children:[e.jsx(T,{children:e.jsx(de,{fontSize:"small"})}),e.jsx(N,{children:"Edit"})]}),e.jsxs(w,{onClick:()=>{Ce(t.file),g({...t,open:!1})},children:[e.jsx(T,{children:e.jsx(Je,{fontSize:"small"})}),e.jsx(N,{children:"Download"})]}),e.jsx(X,{}),e.jsxs(w,{onClick:()=>{R({open:!0,file:t.file,newName:t.file?.name}),g({...t,open:!1})},children:[e.jsx(T,{children:e.jsx(Be,{fontSize:"small"})}),e.jsx(N,{children:"Rename"})]}),e.jsxs(w,{onClick:()=>{z({open:!0,files:[t.file]}),g({...t,open:!1})},children:[e.jsx(T,{children:e.jsx(ce,{fontSize:"small",color:"error"})}),e.jsx(N,{children:"Delete"})]})]}),e.jsxs(b,{open:S.open,onClose:()=>C({open:!1,file:null,content:"",loading:!1}),maxWidth:"lg",fullWidth:!0,children:[e.jsx(D,{children:S.file?.name}),e.jsx(k,{children:S.loading?e.jsx(h,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(q,{})}):e.jsx(h,{sx:{bgcolor:"#0d1117",p:2,borderRadius:1,fontFamily:"monospace",fontSize:"0.8rem",maxHeight:500,overflow:"auto",whiteSpace:"pre-wrap",color:"#e0f7ff"},children:S.content})}),e.jsxs(L,{children:[e.jsx(r,{onClick:()=>{se(S.file),C({open:!1,file:null,content:"",loading:!1})},children:"Edit"}),e.jsx(r,{onClick:()=>C({open:!1,file:null,content:"",loading:!1}),children:"Close"})]})]}),e.jsxs(b,{open:p.open,onClose:()=>!p.saving&&f({open:!1,file:null,content:"",saving:!1}),maxWidth:"lg",fullWidth:!0,children:[e.jsxs(D,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(de,{})," Edit: ",p.file?.name]}),e.jsx(k,{children:e.jsx(Y,{multiline:!0,fullWidth:!0,minRows:20,maxRows:30,value:p.content,onChange:s=>f(n=>({...n,content:s.target.value})),sx:{mt:1,"& .MuiInputBase-input":{fontFamily:"monospace",fontSize:"0.85rem"}}})}),e.jsxs(L,{children:[e.jsx(r,{onClick:()=>f({open:!1,file:null,content:"",saving:!1}),disabled:p.saving,children:"Cancel"}),e.jsx(r,{variant:"contained",startIcon:p.saving?e.jsx(q,{size:16}):e.jsx(Ke,{}),onClick:ge,disabled:p.saving,children:"Save"})]})]}),e.jsxs(b,{open:B.open,onClose:()=>I({open:!1,name:""}),children:[e.jsx(D,{children:"Create New Folder"}),e.jsx(k,{children:e.jsx(Y,{autoFocus:!0,fullWidth:!0,label:"Folder Name",value:B.name,onChange:s=>I(n=>({...n,name:s.target.value})),sx:{mt:1},onKeyPress:s=>s.key==="Enter"&&ne()})}),e.jsxs(L,{children:[e.jsx(r,{onClick:()=>I({open:!1,name:""}),children:"Cancel"}),e.jsx(r,{variant:"contained",onClick:ne,children:"Create"})]})]}),e.jsxs(b,{open:J.open,onClose:()=>{},children:[e.jsx(D,{children:"Uploading File"}),e.jsxs(k,{sx:{minWidth:300},children:[e.jsx(Ze,{variant:"determinate",value:J.progress,sx:{mt:2}}),e.jsxs(d,{variant:"body2",color:"text.secondary",sx:{mt:1,textAlign:"center"},children:[Math.round(J.progress),"%"]})]})]}),e.jsxs(b,{open:E.open,onClose:()=>z({open:!1,files:[]}),children:[e.jsx(D,{children:"Confirm Delete"}),e.jsxs(k,{children:[e.jsxs(d,{children:["Are you sure you want to delete ",E.files.length," item(s)?"]}),e.jsx(h,{sx:{mt:2,maxHeight:200,overflow:"auto"},children:E.files.map(s=>e.jsx(d,{variant:"body2",sx:{fontFamily:"monospace"},children:s.name},s.path))})]}),e.jsxs(L,{children:[e.jsx(r,{onClick:()=>z({open:!1,files:[]}),children:"Cancel"}),e.jsx(r,{variant:"contained",color:"error",onClick:we,children:"Delete"})]})]}),e.jsxs(b,{open:M.open,onClose:()=>R({open:!1,file:null,newName:""}),children:[e.jsx(D,{children:"Rename"}),e.jsx(k,{children:e.jsx(Y,{autoFocus:!0,fullWidth:!0,label:"New Name",value:M.newName,onChange:s=>R(n=>({...n,newName:s.target.value})),sx:{mt:1},onKeyPress:s=>s.key==="Enter"&&oe()})}),e.jsxs(L,{children:[e.jsx(r,{onClick:()=>R({open:!1,file:null,newName:""}),children:"Cancel"}),e.jsx(r,{variant:"contained",onClick:oe,children:"Rename"})]})]})]})};export{ds as default};
