import{r as d,j as e,B as t,H as B,T as o,k as A,I as J,S as V,n as R,l as j,m as I,R as q,X as p,C as X,p as _,D as G,x as K,y as Q,d as Y}from"./index-DHdDvhkS.js";import{A as Z}from"./AccessTime-DJxZ6Chq.js";import{I as k}from"./Info-4pHvpaej.js";import{D as ee}from"./Download-CyW3fd6O.js";import{T as re}from"./TableContainer-B-KnJSOZ.js";import{T as se,a as oe,b as v,c,d as te}from"./TableRow-uixtCDNw.js";import{C as m}from"./Chip-CqU9Trdn.js";import{P as ae}from"./Pagination-DrMbDUbx.js";const x=i=>i==null?"":typeof i=="string"?i:typeof i=="number"||typeof i=="boolean"?String(i):typeof i=="object"?JSON.stringify(i):String(i),pe=()=>{const[i,P]=d.useState([]),[f,F]=d.useState(""),[b,E]=d.useState(""),[M,T]=d.useState(!0),[y,S]=d.useState(1),[n,z]=d.useState({open:!1,log:null}),w=25,U=["","power","system","security","backup","terminal","groups","script","machine","docker","file"],L=async()=>{T(!0);try{const r=f?`/api/audit-log?category=${f}&limit=500`:"/api/audit-log?limit=500",l=(await(await fetch(r)).json()||[]).map(s=>({id:s.id,timestamp:s.created_at||s.timestamp,user:x(s.username||s.user||""),action:x(s.action||""),category:x(s.resource_type||s.category||""),machine_name:x(s.resource_id||s.machine_name||""),target:x(s.resource_id||s.target||""),details:typeof s.details=="object"?JSON.stringify(s.details):x(s.details||""),success:s.success!==void 0?s.success:!s.action?.includes("fail"),error:x(s.error||""),ip_address:x(s.ip_address||"")}));P(l)}catch(r){console.error("Failed to load audit log:",r)}T(!1)};d.useEffect(()=>{L()},[f]);const h=d.useMemo(()=>{if(!b)return i;const r=b.toLowerCase();return i.filter(a=>a.action?.toLowerCase().includes(r)||a.machine_name?.toLowerCase().includes(r)||a.user?.toLowerCase().includes(r)||a.details?.toLowerCase().includes(r))},[i,b]),W=d.useMemo(()=>{const r=(y-1)*w;return h.slice(r,r+w)},[h,y]),D=Math.ceil(h.length/w),$=r=>{if(!r)return"-";let a;if(typeof r=="number")a=new Date(r<1e10?r*1e3:r);else if(typeof r=="string")a=new Date(r);else return"-";if(isNaN(a.getTime()))return"-";const l=new Date-a;return l<0?a.toLocaleString():l<6e4?"Just now":l<36e5?`${Math.floor(l/6e4)}m ago`:l<864e5?`${Math.floor(l/36e5)}h ago`:a.toLocaleString()},O=r=>r?.includes("login")||r?.includes("user")?e.jsx(_,{sx:{fontSize:16}}):r?.includes("machine")||r?.includes("connect")?e.jsx(Y,{sx:{fontSize:16}}):e.jsx(Z,{sx:{fontSize:16}}),C=r=>r?.includes("delete")||r?.includes("remove")||r?.includes("stop")?"#ef4444":r?.includes("create")||r?.includes("add")||r?.includes("start")?"#22c55e":r?.includes("deploy")||r?.includes("run")||r?.includes("execute")?"#f97316":r?.includes("update")||r?.includes("edit")||r?.includes("modify")?"#8b5cf6":"#6b7280",g=r=>({power:"#ef4444",system:"#3b82f6",security:"#f59e0b",backup:"#10b981",terminal:"#8b5cf6",groups:"#ec4899",script:"#f97316",machine:"#06b6d4",docker:"#2563eb",file:"#84cc16"})[r]||"#6b7280",N=()=>{const r=[["Time","User","Action","Category","Machine","Status","Details"],...h.map(s=>[new Date(s.timestamp).toISOString(),s.user||"-",s.action,s.category,s.machine_name||"-",s.success?"Success":"Failed",s.details||""])].map(s=>s.map(H=>`"${String(H).replace(/"/g,'""')}"`).join(",")).join(`
`),a=new Blob([r],{type:"text/csv"}),u=URL.createObjectURL(a),l=document.createElement("a");l.href=u,l.download=`audit-log-${new Date().toISOString().split("T")[0]}.csv`,l.click(),URL.revokeObjectURL(u)};return e.jsxs(t,{sx:{p:3,maxWidth:1400,mx:"auto"},children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,flexWrap:"wrap",gap:2},children:[e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(t,{sx:{width:48,height:48,borderRadius:"12px",background:"linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(249, 115, 22, 0.1) 100%)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(B,{sx:{color:"#f97316",fontSize:24}})}),e.jsxs(t,{children:[e.jsx(o,{variant:"h5",sx:{color:"#fafafa",fontWeight:700},children:"Audit Log"}),e.jsx(o,{variant:"body2",sx:{color:"rgba(255,255,255,0.5)"},children:"Track who did what and when"})]})]}),e.jsxs(t,{sx:{display:"flex",gap:2,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(A,{placeholder:"Search logs...",value:b,onChange:r=>{E(r.target.value),S(1)},size:"small",sx:{width:200},InputProps:{startAdornment:e.jsx(J,{position:"start",children:e.jsx(V,{sx:{color:"rgba(255,255,255,0.3)"}})})}}),e.jsxs(A,{select:!0,label:"Category",value:f,onChange:r=>{F(r.target.value),S(1)},size:"small",sx:{width:140},children:[e.jsx(R,{value:"",children:"All Categories"}),U.filter(r=>r).map(r=>e.jsx(R,{value:r,children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(t,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:g(r)}}),r.charAt(0).toUpperCase()+r.slice(1)]})},r))]}),e.jsx(j,{title:"Export to CSV",children:e.jsx(I,{onClick:N,sx:{color:"#22c55e"},children:e.jsx(ee,{})})}),e.jsx(j,{title:"Refresh",children:e.jsx(I,{onClick:L,sx:{color:"#f97316"},children:e.jsx(q,{})})})]})]}),e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:2,mb:3},children:[e.jsxs(p,{sx:{p:2,bgcolor:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.05)"},children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Total Events"}),e.jsx(o,{variant:"h5",sx:{color:"#fafafa",fontWeight:700},children:i.length})]}),e.jsxs(p,{sx:{p:2,bgcolor:"rgba(34, 197, 94, 0.1)",border:"1px solid rgba(34, 197, 94, 0.2)"},children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Successful"}),e.jsx(o,{variant:"h5",sx:{color:"#22c55e",fontWeight:700},children:i.filter(r=>r.success).length})]}),e.jsxs(p,{sx:{p:2,bgcolor:"rgba(239, 68, 68, 0.1)",border:"1px solid rgba(239, 68, 68, 0.2)"},children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Failed"}),e.jsx(o,{variant:"h5",sx:{color:"#ef4444",fontWeight:700},children:i.filter(r=>!r.success).length})]}),e.jsxs(p,{sx:{p:2,bgcolor:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.05)"},children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Filtered"}),e.jsx(o,{variant:"h5",sx:{color:"#fafafa",fontWeight:700},children:h.length})]})]}),e.jsx(p,{sx:{bgcolor:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.05)",borderRadius:"12px",overflow:"hidden"},children:M?e.jsx(t,{sx:{display:"flex",justifyContent:"center",py:8},children:e.jsx(X,{sx:{color:"#f97316"}})}):e.jsxs(e.Fragment,{children:[e.jsx(re,{children:e.jsxs(se,{children:[e.jsx(oe,{children:e.jsxs(v,{sx:{bgcolor:"rgba(255,255,255,0.02)"},children:[e.jsx(c,{sx:{color:"rgba(255,255,255,0.5)",fontWeight:600,borderBottom:"1px solid rgba(255,255,255,0.05)"},children:"Time"}),e.jsx(c,{sx:{color:"rgba(255,255,255,0.5)",fontWeight:600,borderBottom:"1px solid rgba(255,255,255,0.05)"},children:"User"}),e.jsx(c,{sx:{color:"rgba(255,255,255,0.5)",fontWeight:600,borderBottom:"1px solid rgba(255,255,255,0.05)"},children:"Action"}),e.jsx(c,{sx:{color:"rgba(255,255,255,0.5)",fontWeight:600,borderBottom:"1px solid rgba(255,255,255,0.05)"},children:"Category"}),e.jsx(c,{sx:{color:"rgba(255,255,255,0.5)",fontWeight:600,borderBottom:"1px solid rgba(255,255,255,0.05)"},children:"Target"}),e.jsx(c,{sx:{color:"rgba(255,255,255,0.5)",fontWeight:600,borderBottom:"1px solid rgba(255,255,255,0.05)"},children:"Status"}),e.jsx(c,{sx:{color:"rgba(255,255,255,0.5)",fontWeight:600,borderBottom:"1px solid rgba(255,255,255,0.05)",width:50}})]})}),e.jsxs(te,{children:[W.map((r,a)=>e.jsxs(v,{sx:{"&:hover":{bgcolor:"rgba(249, 115, 22, 0.05)"}},children:[e.jsx(c,{sx:{borderBottom:"1px solid rgba(255,255,255,0.03)"},children:e.jsx(j,{title:new Date(r.timestamp).toLocaleString(),children:e.jsx(o,{sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.85rem"},children:$(r.timestamp)})})}),e.jsx(c,{sx:{borderBottom:"1px solid rgba(255,255,255,0.03)"},children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_,{sx:{fontSize:16,color:"rgba(255,255,255,0.4)"}}),e.jsx(o,{sx:{color:"#fafafa",fontSize:"0.9rem"},children:r.user||"System"})]})}),e.jsx(c,{sx:{borderBottom:"1px solid rgba(255,255,255,0.03)"},children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(t,{sx:{color:C(r.action)},children:O(r.action)}),e.jsx(o,{sx:{color:C(r.action),fontWeight:500,fontSize:"0.9rem"},children:r.action?.replace(/_/g," ")})]})}),e.jsx(c,{sx:{borderBottom:"1px solid rgba(255,255,255,0.03)"},children:e.jsx(m,{label:r.category,size:"small",sx:{bgcolor:`${g(r.category)}20`,color:g(r.category),border:`1px solid ${g(r.category)}40`,fontWeight:500,fontSize:"0.75rem"}})}),e.jsx(c,{sx:{borderBottom:"1px solid rgba(255,255,255,0.03)"},children:e.jsx(o,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.9rem"},children:r.machine_name||r.target||"-"})}),e.jsx(c,{sx:{borderBottom:"1px solid rgba(255,255,255,0.03)"},children:r.success?e.jsx(m,{label:"Success",size:"small",sx:{bgcolor:"rgba(34, 197, 94, 0.2)",color:"#22c55e",fontWeight:500}}):e.jsx(m,{label:"Failed",size:"small",sx:{bgcolor:"rgba(239, 68, 68, 0.2)",color:"#ef4444",fontWeight:500}})}),e.jsx(c,{sx:{borderBottom:"1px solid rgba(255,255,255,0.03)"},children:e.jsx(j,{title:"View Details",children:e.jsx(I,{size:"small",onClick:()=>z({open:!0,log:r}),children:e.jsx(k,{sx:{fontSize:18,color:"rgba(255,255,255,0.4)"}})})})})]},a)),W.length===0&&e.jsx(v,{children:e.jsxs(c,{colSpan:7,sx:{textAlign:"center",color:"rgba(255,255,255,0.4)",py:8},children:[e.jsx(B,{sx:{fontSize:48,opacity:.3,mb:2}}),e.jsx(o,{children:"No audit log entries found"})]})})]})]})}),D>1&&e.jsx(t,{sx:{display:"flex",justifyContent:"center",py:2,borderTop:"1px solid rgba(255,255,255,0.05)"},children:e.jsx(ae,{count:D,page:y,onChange:(r,a)=>S(a),sx:{"& .MuiPaginationItem-root":{color:"rgba(255,255,255,0.7)"}}})})]})}),e.jsxs(G,{open:n.open,onClose:()=>z({open:!1,log:null}),maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{bgcolor:"rgba(20, 20, 20, 0.98)",border:"1px solid rgba(255,255,255,0.1)"}},children:[e.jsxs(K,{sx:{display:"flex",alignItems:"center",gap:1,borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx(k,{sx:{color:"#f97316"}}),"Event Details"]}),e.jsx(Q,{sx:{pt:3},children:n.log&&e.jsxs(t,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Timestamp"}),e.jsx(o,{sx:{color:"#fafafa"},children:new Date(n.log.timestamp).toLocaleString()})]}),e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"User"}),e.jsx(o,{sx:{color:"#fafafa"},children:n.log.user||"System"})]}),e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Action"}),e.jsx(o,{sx:{color:C(n.log.action),fontWeight:500},children:n.log.action?.replace(/_/g," ")})]}),e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Category"}),e.jsx(m,{label:n.log.category,size:"small",sx:{ml:1,bgcolor:`${g(n.log.category)}20`,color:g(n.log.category)}})]}),e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Target"}),e.jsx(o,{sx:{color:"#fafafa"},children:n.log.machine_name||n.log.target||"-"})]}),e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Status"}),e.jsx(o,{sx:{color:n.log.success?"#22c55e":"#ef4444"},children:n.log.success?"Success":"Failed"})]}),n.log.details&&e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Details"}),e.jsx(t,{sx:{bgcolor:"rgba(0,0,0,0.3)",p:2,borderRadius:1,mt:.5},children:e.jsx(o,{sx:{color:"rgba(255,255,255,0.8)",fontFamily:"monospace",fontSize:"0.85rem",whiteSpace:"pre-wrap"},children:n.log.details})})]}),n.log.error&&e.jsxs(t,{children:[e.jsx(o,{variant:"caption",sx:{color:"rgba(255,255,255,0.5)"},children:"Error"}),e.jsx(t,{sx:{bgcolor:"rgba(239, 68, 68, 0.1)",p:2,borderRadius:1,mt:.5,border:"1px solid rgba(239, 68, 68, 0.3)"},children:e.jsx(o,{sx:{color:"#ef4444",fontFamily:"monospace",fontSize:"0.85rem"},children:n.log.error})})]})]})})]})]})};export{pe as default};
