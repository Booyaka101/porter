import{ah as re,ai as ne,r,aj as ie,j as e,ak as le,J as oe,al as ce,u as de,ab as xe,B as l,C as ue,g as t,m as z,T as o,t as $,d as U,b as u,A as L,w as R,e as he,f as me,l as V,P as G,D as q,x as J,y as H,k as b}from"./index-DfzNkgux.js";import{E as pe}from"./Edit-Qm4BJS6P.js";import{D as ge}from"./Delete-CUPdazwc.js";import{A as be}from"./ArrowBack-fyLYNved.js";import{G as M}from"./Grid-BzAoS5fi.js";import{C as Y}from"./Chip-CJRM8HuN.js";import{D as K}from"./DialogActions-BlQbCahF.js";function fe(c){return re("MuiCardActions",c)}ne("MuiCardActions",["root","spacing"]);const je=c=>{const{classes:d,disableSpacing:a}=c;return ce({root:["root",!a&&"spacing"]},fe,d)},Ce=le("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(c,d)=>{const{ownerState:a}=c;return[d.root,!a.disableSpacing&&d.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),ye=r.forwardRef(function(d,a){const h=ie({props:d,name:"MuiCardActions"}),{disableSpacing:D=!1,className:x,...B}=h,f={...h,disableSpacing:D},A=je(f);return e.jsx(Ce,{className:oe(A.root,x),ownerState:f,ref:a,...B})}),Ie=()=>{const c=de(),[d]=xe(),a=d.get("machine"),[h,D]=r.useState([]),[x,B]=r.useState([]),[f,A]=r.useState(!0),[Q,j]=r.useState(!1),[C,T]=r.useState(null),[X,y]=r.useState(!1),[v,Z]=r.useState(null),[p,I]=r.useState(""),[g,F]=r.useState(""),[W,S]=r.useState(""),[n,m]=r.useState({name:"",customer:"",pack:"",branch:""});r.useEffect(()=>{P()},[]),r.useEffect(()=>{a&&x.length>0&&x.find(i=>i.id===a)&&I(a)},[a,x]);const P=async()=>{try{const[s,i]=await Promise.all([fetch("/api/build-clients"),fetch("/api/machines")]),O=await s.json(),ae=await i.json();D(O||[]);const k=(ae||[]).filter(w=>w.tags?.includes("build")||w.tags?.includes("deploy"));B(k),a&&k.find(w=>w.id===a)?I(a):k.length>0&&!p&&I(k[0].id)}catch(s){S("Failed to load data: "+s.message)}finally{A(!1)}},E=(s=null)=>{s?(T(s),m({name:s.name,customer:s.customer,pack:s.pack,branch:s.branch})):(T(null),m({name:"",customer:"",pack:"",branch:""})),j(!0)},_=async()=>{try{const s=C?`/api/build-clients/${C.id}`:"/api/build-clients";if(!(await fetch(s,{method:C?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok)throw new Error("Failed to save client");j(!1),P()}catch(s){S("Failed to save client: "+s.message)}},ee=async s=>{if(window.confirm("Delete this client?"))try{if(!(await fetch(`/api/build-clients/${s}`,{method:"DELETE"})).ok)throw new Error("Failed to delete client");P()}catch(i){S("Failed to delete client: "+i.message)}},se=s=>{Z(s),F(""),y(!0)},te=()=>{if(!v||!p||!g)return;const s=[`--client=${v.name.toLowerCase()}`,`--version=${g}`,"--auto-install"],i=encodeURIComponent(s.join(" "));c(`/scripts/build-deploy%2FbuildBundle.sh?machines=${p}&step=3&flags=${i}`),y(!1)},N=()=>x.find(i=>i.id===p)?.name||"Unknown";return f?e.jsx(l,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",minHeight:400},children:e.jsx(ue,{sx:{color:t.primary}})}):e.jsxs(l,{sx:{p:3},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:3},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(z,{onClick:()=>c("/machines"),sx:{color:t.text.muted},children:e.jsx(be,{})}),e.jsxs(l,{children:[e.jsxs(o,{variant:"h4",sx:{color:t.text.primary,display:"flex",alignItems:"center",gap:1},children:[e.jsx($,{sx:{color:t.primary}}),"Build Clients"]}),a&&e.jsxs(o,{sx:{color:t.text.muted,fontSize:"0.9rem",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(U,{sx:{fontSize:16}}),"Building on: ",e.jsx("strong",{children:N()})]})]})]}),e.jsx(u,{variant:"contained",startIcon:e.jsx(L,{}),onClick:()=>E(),sx:{bgcolor:t.primary,"&:hover":{bgcolor:t.primaryDark}},children:"Add Client"})]}),W&&e.jsx(R,{severity:"error",sx:{mb:2},onClose:()=>S(""),children:W}),x.length===0&&e.jsx(R,{severity:"warning",sx:{mb:2},children:"No machines with 'build' or 'deploy' tags found. Add these tags to machines that can run builds."}),e.jsx(M,{container:!0,spacing:2,children:h.length===0?e.jsx(M,{item:!0,xs:12,children:e.jsxs(l,{sx:{textAlign:"center",py:6,color:t.text.muted,bgcolor:"rgba(255,255,255,0.02)",borderRadius:2,border:"1px dashed rgba(255,255,255,0.1)"},children:[e.jsx($,{sx:{fontSize:48,mb:2,opacity:.5}}),e.jsx(o,{variant:"h6",children:"No clients configured"}),e.jsx(o,{sx:{mb:2},children:"Add a client to start building"}),e.jsx(u,{variant:"outlined",startIcon:e.jsx(L,{}),onClick:()=>E(),sx:{color:t.primary,borderColor:t.primary},children:"Add First Client"})]})}):h.map(s=>e.jsx(M,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(he,{sx:{bgcolor:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2,transition:"all 0.2s","&:hover":{borderColor:t.primary,transform:"translateY(-2px)"}},children:[e.jsxs(me,{children:[e.jsx(o,{variant:"h6",sx:{color:t.text.primary,mb:1},children:s.name}),e.jsxs(l,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:1},children:[e.jsx(Y,{size:"small",label:`Customer: ${s.customer}`,sx:{bgcolor:"rgba(249, 115, 22, 0.1)",color:t.primary}}),e.jsx(Y,{size:"small",label:`Pack: ${s.pack}`,sx:{bgcolor:"rgba(34, 197, 94, 0.1)",color:"#22c55e"}})]}),s.branch&&e.jsxs(o,{sx:{color:t.text.muted,fontSize:"0.85rem"},children:["Branch: ",s.branch]})]}),e.jsxs(ye,{sx:{justifyContent:"space-between",px:2,pb:2},children:[e.jsxs(l,{children:[e.jsx(V,{title:"Edit",children:e.jsx(z,{size:"small",onClick:()=>E(s),sx:{color:t.text.muted},children:e.jsx(pe,{fontSize:"small"})})}),e.jsx(V,{title:"Delete",children:e.jsx(z,{size:"small",onClick:()=>ee(s.id),sx:{color:"#ff4466"},children:e.jsx(ge,{fontSize:"small"})})})]}),e.jsx(u,{variant:"contained",size:"small",startIcon:e.jsx(G,{}),onClick:()=>se(s),disabled:x.length===0,sx:{bgcolor:"#22c55e","&:hover":{bgcolor:"#16a34a"},"&:disabled":{bgcolor:"rgba(255,255,255,0.1)"}},children:"Build"})]})]})},s.id))}),e.jsxs(q,{open:Q,onClose:()=>j(!1),maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{bgcolor:"#1a1a2e",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2}},children:[e.jsx(J,{sx:{color:t.text.primary},children:C?"Edit Client":"Add Client"}),e.jsxs(H,{children:[e.jsx(b,{fullWidth:!0,label:"Client Name",value:n.name,onChange:s=>m({...n,name:s.target.value}),sx:{mt:2,mb:2},placeholder:"e.g., solaire, inspire, idx"}),e.jsx(b,{fullWidth:!0,label:"Customer",value:n.customer,onChange:s=>m({...n,customer:s.target.value}),sx:{mb:2},placeholder:"Customer name for build output"}),e.jsx(b,{fullWidth:!0,label:"Pack",value:n.pack,onChange:s=>m({...n,pack:s.target.value}),sx:{mb:2},placeholder:"Pack name (usually same as customer)"}),e.jsx(b,{fullWidth:!0,label:"Branch",value:n.branch,onChange:s=>m({...n,branch:s.target.value}),placeholder:"Git branch (default: master)"})]}),e.jsxs(K,{sx:{px:3,pb:2},children:[e.jsx(u,{onClick:()=>j(!1),sx:{color:t.text.muted},children:"Cancel"}),e.jsx(u,{onClick:_,variant:"contained",disabled:!n.name||!n.customer||!n.pack,sx:{bgcolor:t.primary},children:"Save"})]})]}),e.jsxs(q,{open:X,onClose:()=>y(!1),maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{bgcolor:"#1a1a2e",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2}},children:[e.jsxs(J,{sx:{color:t.text.primary},children:["Build ",v?.name]}),e.jsxs(H,{children:[e.jsxs(R,{severity:"info",sx:{mb:2},children:["This will run ",e.jsx("code",{children:"buildBundle.sh"})," with ",e.jsx("code",{children:"--auto-install"})," enabled."]}),e.jsx(o,{sx:{color:t.text.muted,mb:1,fontSize:"0.85rem"},children:"Build Machine"}),e.jsx(l,{sx:{p:2,mb:2,bgcolor:"rgba(0,0,0,0.2)",borderRadius:1,border:"1px solid rgba(255,255,255,0.1)"},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(U,{sx:{color:t.primary}}),e.jsx(o,{sx:{color:t.text.primary},children:N()})]})}),e.jsx(b,{fullWidth:!0,label:"Version",value:g,onChange:s=>F(s.target.value),placeholder:"e.g., 1.2.3",required:!0,helperText:"Version tag for this build (required)",sx:{mb:2}}),e.jsx(o,{sx:{color:t.text.muted,mb:1,fontSize:"0.85rem"},children:"Build Configuration"}),e.jsx(l,{sx:{p:2,bgcolor:"rgba(0,0,0,0.2)",borderRadius:1,border:"1px solid rgba(255,255,255,0.1)"},children:e.jsxs(o,{sx:{color:t.text.primary,fontFamily:"monospace",fontSize:"0.85rem"},children:["--client=",v?.name.toLowerCase(),e.jsx("br",{}),"--version=",g||"<version>",e.jsx("br",{}),"--auto-install"]})})]}),e.jsxs(K,{sx:{px:3,pb:2},children:[e.jsx(u,{onClick:()=>y(!1),sx:{color:t.text.muted},children:"Cancel"}),e.jsx(u,{onClick:te,variant:"contained",startIcon:e.jsx(G,{}),disabled:!g||!p,sx:{bgcolor:"#22c55e","&:hover":{bgcolor:"#16a34a"}},children:"Start Build"})]})]})]})};export{Ie as default};
