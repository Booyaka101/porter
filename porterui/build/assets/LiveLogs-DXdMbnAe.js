import{r as s,j as e,B as i,T as f,X as R,a4 as P,a5 as O,a2 as T,n as S,k as C,b,P as F,C as Y}from"./index-BR8HzIu-.js";import{S as Z}from"./Stop-CnP__ldM.js";import{D as _}from"./Delete-DwUrccAH.js";import{D as ee}from"./Download-FYTa3SsS.js";import{P as te}from"./Pause-CU6NakRL.js";import{C as U}from"./Chip-CiJfAjDW.js";const ie=()=>{const[$,B]=s.useState([]),[c,J]=s.useState(""),[g,M]=s.useState("journalctl"),[y,W]=s.useState(""),[E,z]=s.useState(50),[w,N]=s.useState(""),[v,A]=s.useState(!1),[p,d]=s.useState([]),[o,j]=s.useState(!1),[l,D]=s.useState(!1),[k,I]=s.useState(null),u=s.useRef(null),L=s.useRef(null),x=s.useRef([]);s.useEffect(()=>{fetch("/api/machines").then(t=>t.json()).then(t=>B(t||[])).catch(t=>console.error("Failed to load machines:",t))},[]),s.useEffect(()=>{!l&&L.current&&L.current.scrollIntoView({behavior:"smooth"})},[p,l]),s.useEffect(()=>{const t=()=>{u.current&&(u.current.close(),u.current=null)},m=()=>{t(),c&&o&&navigator.sendBeacon(`/api/logs/stop/${c}`)};return window.addEventListener("beforeunload",m),()=>{window.removeEventListener("beforeunload",m),t()}},[c,o]);const V=()=>{if(!c){I("Please select a machine");return}I(null),d([]),j(!0),D(!1);const t=new URLSearchParams({type:g,lines:E.toString()});y&&t.set("target",y),w&&t.set("filters",w),v&&t.set("sudo","true");const m=`/api/logs/live/${c}?${t.toString()}`,a=new EventSource(m);u.current=a,a.addEventListener("connected",r=>{const n=JSON.parse(r.data);d(h=>[...h,{type:"system",line:`Connected to ${n.type} stream for ${n.target||"all"}`,timestamp:new Date().toISOString()}])}),a.addEventListener("log",r=>{const n=JSON.parse(r.data),h={type:"log",line:n.line,source:n.source,timestamp:new Date().toISOString()};l?x.current.push(h):d(Q=>[...Q,h])}),a.addEventListener("error",r=>{if(r.data){const n=JSON.parse(r.data);I(n.error)}j(!1)}),a.addEventListener("closed",r=>{const n=JSON.parse(r.data);d(h=>[...h,{type:"system",line:`Stream closed: ${n.reason}`,timestamp:new Date().toISOString()}]),j(!1)}),a.onerror=r=>{a.readyState===EventSource.CLOSED&&u.current===a&&(console.log("SSE connection closed unexpectedly"),j(!1),d(n=>[...n,{type:"system",line:"Connection lost - stream ended",timestamp:new Date().toISOString()}]))}},X=()=>{u.current&&(u.current.close(),u.current=null),j(!1),d(t=>[...t,{type:"system",line:"Stream stopped by user",timestamp:new Date().toISOString()}])},q=()=>{l&&(d(t=>[...t,...x.current]),x.current=[]),D(!l)},G=()=>{d([]),x.current=[]},H=()=>{const t=p.map(n=>`[${n.timestamp}] ${n.line}`).join(`
`),m=new Blob([t],{type:"text/plain"}),a=URL.createObjectURL(m),r=document.createElement("a");r.href=a,r.download=`logs-${c}-${new Date().toISOString()}.txt`,r.click(),URL.revokeObjectURL(a)},K=()=>{switch(g){case"journalctl":case"journalctl-user":return"Unit name (e.g., nginx, sshd) - leave empty for all";case"tail":return"File path (e.g., /var/log/syslog)";case"docker":return"Container name or ID";case"compose":return"Compose file path:service (e.g., /app/docker-compose.yml:web)";default:return"Target"}};return e.jsxs(i,{children:[e.jsx(f,{variant:"h4",sx:{mb:3,fontWeight:700},children:"Live Logs"}),e.jsxs(R,{sx:{p:3,mb:3},children:[e.jsxs(i,{sx:{display:"flex",gap:2,flexWrap:"wrap",alignItems:"flex-end"},children:[e.jsxs(P,{sx:{minWidth:200},children:[e.jsx(O,{children:"Machine"}),e.jsx(T,{value:c,onChange:t=>J(t.target.value),label:"Machine",disabled:o,children:$.map(t=>e.jsx(S,{value:t.id,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:t.status==="online"?"#22c55e":"#ff3366"}}),t.name," (",t.ip,")"]})},t.id))})]}),e.jsxs(P,{sx:{minWidth:180},children:[e.jsx(O,{children:"Log Type"}),e.jsxs(T,{value:g,onChange:t=>M(t.target.value),label:"Log Type",disabled:o,children:[e.jsx(S,{value:"journalctl",children:"Journalctl (System)"}),e.jsx(S,{value:"journalctl-user",children:"Journalctl (User)"}),e.jsx(S,{value:"tail",children:"Tail File"}),e.jsx(S,{value:"docker",children:"Docker Container"}),e.jsx(S,{value:"compose",children:"Docker Compose"})]})]}),e.jsx(C,{label:"Target",value:y,onChange:t=>W(t.target.value),placeholder:K(),disabled:o,sx:{minWidth:300,flex:1}}),e.jsx(C,{label:"Initial Lines",type:"number",value:E,onChange:t=>z(parseInt(t.target.value)||50),disabled:o,sx:{width:120}})]}),(g==="journalctl"||g==="journalctl-user")&&e.jsx(i,{sx:{mt:2},children:e.jsx(C,{label:"Filters",value:w,onChange:t=>N(t.target.value),placeholder:"e.g., --priority=err --grep=error",disabled:o,fullWidth:!0,size:"small"})}),g==="tail"&&e.jsx(i,{sx:{mt:2},children:e.jsx(U,{label:"Use Sudo",onClick:()=>A(!v),color:v?"primary":"default",variant:v?"filled":"outlined",disabled:o})}),e.jsxs(i,{sx:{mt:3,display:"flex",gap:2},children:[o?e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"contained",color:"error",startIcon:e.jsx(Z,{}),onClick:X,children:"Stop"}),e.jsx(b,{variant:"outlined",startIcon:l?e.jsx(F,{}):e.jsx(te,{}),onClick:q,children:l?"Resume":"Pause"})]}):e.jsx(b,{variant:"contained",startIcon:e.jsx(F,{}),onClick:V,disabled:!c,children:"Start Streaming"}),e.jsx(b,{variant:"outlined",startIcon:e.jsx(_,{}),onClick:G,disabled:p.length===0,children:"Clear"}),e.jsx(b,{variant:"outlined",startIcon:e.jsx(ee,{}),onClick:H,disabled:p.length===0,children:"Download"})]}),k&&e.jsx(f,{color:"error",sx:{mt:2},children:k})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2,px:1},children:[o&&e.jsx(U,{icon:e.jsx(Y,{size:14}),label:l?"Paused":"Streaming",color:l?"warning":"success",size:"small"}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:[p.length," lines"]}),l&&x.current.length>0&&e.jsxs(f,{variant:"body2",color:"warning.main",children:["(",x.current.length," buffered)"]})]}),e.jsx(R,{sx:{p:0,bgcolor:"#0d1117",border:"1px solid rgba(249, 115, 22, 0.2)",borderRadius:2,overflow:"hidden"},children:e.jsxs(i,{sx:{height:500,overflow:"auto",fontFamily:'"JetBrains Mono", "Fira Code", monospace',fontSize:"0.8rem",p:2},children:[p.length===0?e.jsx(f,{color:"text.secondary",sx:{fontStyle:"italic"},children:'No logs yet. Select a machine and click "Start Streaming" to begin.'}):p.map((t,m)=>e.jsxs(i,{sx:{py:.3,borderBottom:"1px solid rgba(255,255,255,0.03)",color:t.type==="system"?"#f97316":t.source?.includes("stderr")?"#ff6b6b":"#e0f7ff","&:hover":{bgcolor:"rgba(255,255,255,0.02)"}},children:[e.jsx(f,{component:"span",sx:{color:"rgba(255,255,255,0.3)",fontSize:"0.7rem",mr:1},children:new Date(t.timestamp).toLocaleTimeString()}),t.line]},m)),e.jsx("div",{ref:L})]})})]})};export{ie as default};
