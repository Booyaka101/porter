import{ah as ae,ai as te,r as t,aj as ie,j as e,ak as ne,G as le,al as re,u as oe,B as n,C as z,T as l,g as a,aa as N,b as p,A as ce,v as U,e as de,f as ue,m as L,P as V,D as G,w as q,x as J,k as f,a3 as he,a4 as xe,a1 as me,n as pe}from"./index-BShrJcTY.js";import{E as ge}from"./Edit-d6qC9kq-.js";import{D as be}from"./Delete-B-bj0F0y.js";import{G as E}from"./Grid-xf7K1Fu7.js";import{C as _}from"./Chip-CABxJAAn.js";import{D as H}from"./DialogActions-CIAGApUj.js";function fe(c){return ae("MuiCardActions",c)}te("MuiCardActions",["root","spacing"]);const je=c=>{const{classes:o,disableSpacing:u}=c;return re({root:["root",!u&&"spacing"]},fe,o)},ye=ne("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(c,o)=>{const{ownerState:u}=c;return[o.root,!u.disableSpacing&&o.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),Ce=t.forwardRef(function(o,u){const h=ie({props:o,name:"MuiCardActions"}),{disableSpacing:k=!1,className:D,...w}=h,j={...h,disableSpacing:k},y=je(j);return e.jsx(ye,{className:le(y.root,D),ownerState:j,ref:u,...w})}),Ae=()=>{const c=oe(),[o,u]=t.useState([]),[h,k]=t.useState([]),[D,w]=t.useState(!0),[j,y]=t.useState(!1),[C,B]=t.useState(null),[K,v]=t.useState(!1),[r,Q]=t.useState(null),[S,T]=t.useState(""),[d,$]=t.useState(""),[M,P]=t.useState({}),[O,g]=t.useState(""),[i,x]=t.useState({name:"",customer:"",pack:"",branch:""});t.useEffect(()=>{A()},[]);const A=async()=>{try{const[s,m]=await Promise.all([fetch("/api/build-clients"),fetch("/api/machines")]),b=await s.json(),se=await m.json();u(b||[]);const F=(se||[]).filter(W=>W.tags?.includes("build")||W.tags?.includes("deploy"));k(F),F.length>0&&T(F[0].id)}catch(s){g("Failed to load data: "+s.message)}finally{w(!1)}},R=(s=null)=>{s?(B(s),x({name:s.name,customer:s.customer,pack:s.pack,branch:s.branch})):(B(null),x({name:"",customer:"",pack:"",branch:""})),y(!0)},I=()=>{y(!1),B(null),x({name:"",customer:"",pack:"",branch:""})},X=async()=>{try{const s=C?`/api/build-clients/${C.id}`:"/api/build-clients";if(!(await fetch(s,{method:C?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok)throw new Error("Failed to save");I(),A()}catch(s){g("Failed to save: "+s.message)}},Y=async s=>{if(window.confirm("Delete this build client?"))try{await fetch(`/api/build-clients/${s}`,{method:"DELETE"}),A()}catch(m){g("Failed to delete: "+m.message)}},Z=s=>{Q(s),$(s.version||""),v(!0)},ee=async()=>{if(!(!S||!r)){P(s=>({...s,[r.id]:!0})),v(!1);try{const s=`--customer=${r.customer} --pack=${r.pack} --branch=${r.branch}${d?` --version=${d}`:""} --auto-install`,m=await fetch("/api/execute-script",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({script_path:"build-deploy/buildBundle.sh",machine_ids:[S],args:s})});if(!m.ok)throw new Error("Failed to trigger build");const b=await m.json();b.id&&c(`/history?execution=${b.id}`)}catch(s){g("Failed to trigger build: "+s.message)}finally{P(s=>({...s,[r.id]:!1}))}}};return D?e.jsx(n,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(z,{})}):e.jsxs(n,{sx:{p:3},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(l,{variant:"h5",sx:{color:a.text.primary,display:"flex",alignItems:"center",gap:1},children:[e.jsx(N,{})," Build Clients"]}),e.jsx(p,{variant:"contained",startIcon:e.jsx(ce,{}),onClick:()=>R(),sx:{bgcolor:a.primary},children:"Add Client"})]}),O&&e.jsx(U,{severity:"error",sx:{mb:2},onClose:()=>g(""),children:O}),h.length===0&&e.jsx(U,{severity:"warning",sx:{mb:2},children:'No build machines found. Add machines with "build" or "deploy" tags to enable 1-click builds.'}),e.jsxs(E,{container:!0,spacing:2,children:[o.map(s=>e.jsx(E,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(de,{sx:{bgcolor:a.surface,border:`1px solid ${a.border}`,"&:hover":{borderColor:a.primary}},children:[e.jsxs(ue,{children:[e.jsx(l,{variant:"h6",sx:{color:a.text.primary,mb:1},children:s.name}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsx(n,{sx:{display:"flex",gap:1},children:e.jsx(_,{label:`Customer: ${s.customer}`,size:"small"})}),e.jsx(n,{sx:{display:"flex",gap:1},children:e.jsx(_,{label:`Pack: ${s.pack}`,size:"small",variant:"outlined"})}),e.jsxs(l,{variant:"body2",sx:{color:a.text.muted,mt:1},children:["Branch: ",s.branch]})]})]}),e.jsxs(Ce,{sx:{justifyContent:"space-between"},children:[e.jsxs(n,{children:[e.jsx(L,{size:"small",onClick:()=>R(s),children:e.jsx(ge,{fontSize:"small"})}),e.jsx(L,{size:"small",onClick:()=>Y(s.id),color:"error",children:e.jsx(be,{fontSize:"small"})})]}),e.jsx(p,{variant:"contained",size:"small",startIcon:M[s.id]?e.jsx(z,{size:16}):e.jsx(V,{}),onClick:()=>Z(s),disabled:M[s.id]||h.length===0,sx:{bgcolor:a.success},children:"Build"})]})]})},s.id)),o.length===0&&e.jsx(E,{item:!0,xs:12,children:e.jsxs(n,{sx:{textAlign:"center",py:6,color:a.text.muted,border:`2px dashed ${a.border}`,borderRadius:2},children:[e.jsx(N,{sx:{fontSize:48,mb:2,opacity:.5}}),e.jsx(l,{children:"No build clients configured"}),e.jsx(l,{variant:"body2",children:'Click "Add Client" to create your first build configuration'})]})})]}),e.jsxs(G,{open:j,onClose:I,maxWidth:"sm",fullWidth:!0,children:[e.jsx(q,{children:C?"Edit Build Client":"Add Build Client"}),e.jsx(J,{children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(f,{label:"Name",value:i.name,onChange:s=>x({...i,name:s.target.value}),fullWidth:!0,placeholder:"e.g., Inspire Production"}),e.jsx(f,{label:"Customer",value:i.customer,onChange:s=>x({...i,customer:s.target.value}),fullWidth:!0,placeholder:"e.g., inspire"}),e.jsx(f,{label:"Pack",value:i.pack,onChange:s=>x({...i,pack:s.target.value}),fullWidth:!0,placeholder:"e.g., inspire"}),e.jsx(f,{label:"Branch",value:i.branch,onChange:s=>x({...i,branch:s.target.value}),fullWidth:!0,placeholder:"e.g., customer/inspire-xtrend"})]})}),e.jsxs(H,{children:[e.jsx(p,{onClick:I,children:"Cancel"}),e.jsx(p,{onClick:X,variant:"contained",disabled:!i.name||!i.customer||!i.branch,children:"Save"})]})]}),e.jsxs(G,{open:K,onClose:()=>v(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(q,{children:["Trigger Build: ",r?.name]}),e.jsx(J,{children:e.jsxs(n,{sx:{mt:2},children:[e.jsxs(he,{fullWidth:!0,children:[e.jsx(xe,{children:"Build Machine"}),e.jsx(me,{value:S,onChange:s=>T(s.target.value),label:"Build Machine",children:h.map(s=>e.jsxs(pe,{value:s.id,children:[s.name," (",s.host,")"]},s.id))})]}),e.jsx(f,{label:"Version",value:d,onChange:s=>$(s.target.value),fullWidth:!0,placeholder:"e.g., 1.2.3",sx:{mt:2},required:!0,error:!d,helperText:d?"":"Version is required for the build"}),e.jsxs(n,{sx:{mt:2,p:2,bgcolor:a.background,borderRadius:1},children:[e.jsx(l,{variant:"body2",sx:{color:a.text.muted,mb:1},children:"Build will run with:"}),e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace"},children:["--customer=",r?.customer]}),e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace"},children:["--pack=",r?.pack]}),e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace"},children:["--branch=",r?.branch]}),d&&e.jsxs(l,{variant:"body2",sx:{fontFamily:"monospace",color:a.primary},children:["--version=",d]}),e.jsx(l,{variant:"body2",sx:{fontFamily:"monospace",color:a.success},children:"--auto-install"})]})]})}),e.jsxs(H,{children:[e.jsx(p,{onClick:()=>v(!1),children:"Cancel"}),e.jsx(p,{onClick:ee,variant:"contained",startIcon:e.jsx(V,{}),disabled:!S||!d,sx:{bgcolor:a.success},children:"Start Build"})]})]})]})};export{Ae as default};
