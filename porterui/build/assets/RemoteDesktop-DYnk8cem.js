import{a8 as U,u as Y,r,aC as Z,j as e,B as l,g as t,m as E,T as a,K as G,M as J,n as f,o as h,Z as X,l as ee,b as R,w as ne,C as te}from"./index-DsbQFb1R.js";import{A as se}from"./ArrowBack-CEEisvg6.js";import{D as w,F as re,a as oe}from"./FullscreenExit-BwiWCbPO.js";import{P as le}from"./PowerSettingsNew-DCtop5tk.js";import{C as ce}from"./Chip-Curpsm0X.js";const ge=()=>{const{id:m}=U(),D=Y(),g=r.useRef(null),n=r.useRef(null),C=r.useRef(null),[c,V]=r.useState(null),[S,I]=r.useState(null),[b,y]=r.useState(!1),[p,j]=r.useState(!1),[v,d]=r.useState(null),[A,k]=r.useState(!1),[K,u]=r.useState(null),[F,P]=r.useState(!1),[ie,ae]=r.useState(6),[de,ue]=r.useState(!0);r.useEffect(()=>{(async()=>{try{const x=(await(await fetch("/api/machines")).json()).find(Q=>Q.id===m);x?V(x):d("Machine not found")}catch{d("Failed to load machine info")}})()},[m]);const T=r.useCallback(()=>new Promise((s,o)=>{if(window.RFB){s(window.RFB);return}const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/lib/rfb.js",i.type="module",i.onload=()=>{Z(()=>import("https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js"),[]).then(x=>{window.RFB=x.default,s(x.default)}).catch(o)},i.onerror=o,document.head.appendChild(i)}),[]),B=async()=>{if(c){y(!0),d(null);try{const o=await(await fetch(`/api/vnc/${m}/start`,{method:"POST"})).json();if(!o.success)throw new Error(o.error||"Failed to start VNC server");I(o.session),await N(o.session)}catch(s){d(s.message),y(!1)}}},N=async s=>{try{const o=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/vnc/${m}/websocket`;try{const i=await T();g.current&&i&&(n.current=new i(g.current,o,{credentials:{password:""}}),n.current.addEventListener("connect",()=>{j(!0),y(!1)}),n.current.addEventListener("disconnect",x=>{j(!1),x.detail.clean?d(null):d("Connection lost")}),n.current.addEventListener("securityfailure",x=>{d(`Security error: ${x.detail.reason}`)}),n.current.scaleViewport=!0,n.current.resizeSession=!0,n.current.focusOnClick=!0,n.current.clipViewport=!0,g.current&&g.current.focus())}catch{console.log("noVNC not available, using fallback"),j(!0),y(!1)}}catch(o){d(`Connection failed: ${o.message}`),y(!1)}},O=async()=>{n.current&&(n.current.disconnect(),n.current=null);try{await fetch(`/api/vnc/${m}/stop`,{method:"POST"})}catch(s){console.error("Failed to stop VNC:",s)}I(null),j(!1)},M=()=>{C.current&&(document.fullscreenElement?(document.exitFullscreen(),k(!1)):(C.current.requestFullscreen(),k(!0)))},$=()=>{n.current?(console.log("Sending Ctrl+Alt+Del"),n.current.sendCtrlAltDel()):console.log("RFB not connected"),u(null)},L=()=>{n.current?(console.log("Sending Alt+Tab"),n.current.sendKey(65513,null,!0),n.current.sendKey(65289,null,!0),n.current.sendKey(65289,null,!1),n.current.sendKey(65513,null,!1)):console.log("RFB not connected"),u(null)},z=()=>{n.current?(console.log("Sending Super key"),n.current.sendKey(65515,null,!0),n.current.sendKey(65515,null,!1)):console.log("RFB not connected"),u(null)},W=()=>{n.current?(console.log("Sending Alt+F4"),n.current.sendKey(65513,null,!0),n.current.sendKey(65473,null,!0),n.current.sendKey(65473,null,!1),n.current.sendKey(65513,null,!1)):console.log("RFB not connected"),u(null)},_=()=>{n.current?(console.log("Sending Escape"),n.current.sendKey(65307,null,!0),n.current.sendKey(65307,null,!1)):console.log("RFB not connected"),u(null)},q=()=>{n.current?(console.log("Sending Print Screen"),n.current.sendKey(65377,null,!0),n.current.sendKey(65377,null,!1)):console.log("RFB not connected"),u(null)},H=()=>{const s=!F;P(s),n.current&&(console.log("Setting viewOnly to",s),n.current.viewOnly=s),u(null)};return r.useEffect(()=>()=>{n.current&&n.current.disconnect()},[]),r.useEffect(()=>{const s=()=>{const o=!!document.fullscreenElement;k(o),n.current&&setTimeout(()=>{n.current&&(n.current.scaleViewport=!1,n.current.scaleViewport=!0)},100)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs(l,{sx:{p:3,height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,pb:2,borderBottom:`1px solid ${t.border.light}`},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(E,{onClick:()=>D(-1),sx:{color:t.text.secondary},children:e.jsx(se,{})}),e.jsxs(l,{children:[e.jsxs(a,{variant:"h5",sx:{color:t.text.primary,fontWeight:700,display:"flex",alignItems:"center",gap:1},children:[e.jsx(w,{sx:{color:t.primary}}),"Remote Desktop"]}),c&&e.jsxs(a,{sx:{color:t.text.secondary,fontSize:"0.9rem"},children:[c.name," (",c.ip,")"]})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[p&&e.jsxs(e.Fragment,{children:[e.jsx(ce,{label:"Connected",size:"small",sx:{background:"rgba(34, 197, 94, 0.1)",color:t.secondary,fontWeight:600}}),e.jsx(E,{onClick:s=>{s.stopPropagation(),u(s.currentTarget)},sx:{color:t.text.muted},title:"Special Keys",children:e.jsx(G,{})}),e.jsxs(J,{anchorEl:K,open:!!K,onClose:()=>u(null),PaperProps:{sx:{background:"rgba(17, 24, 39, 0.95)",backdropFilter:"blur(10px)",border:`1px solid ${t.border.light}`,minWidth:200}},children:[e.jsx(f,{onClick:$,children:e.jsx(h,{primary:"Ctrl + Alt + Del"})}),e.jsx(f,{onClick:L,children:e.jsx(h,{primary:"Alt + Tab"})}),e.jsx(f,{onClick:z,children:e.jsx(h,{primary:"Super / Windows Key"})}),e.jsx(f,{onClick:W,children:e.jsx(h,{primary:"Alt + F4"})}),e.jsx(f,{onClick:_,children:e.jsx(h,{primary:"Escape"})}),e.jsx(f,{onClick:q,children:e.jsx(h,{primary:"Print Screen"})}),e.jsx(X,{sx:{borderColor:t.border.light}}),e.jsx(f,{onClick:H,children:e.jsx(h,{primary:F?"Enable Input":"View Only Mode",secondary:F?"Currently view-only":"Disable keyboard/mouse"})})]}),e.jsx(ee,{title:A?"Exit Fullscreen":"Fullscreen",children:e.jsx(E,{onClick:M,sx:{color:t.text.muted},children:A?e.jsx(re,{}):e.jsx(oe,{})})}),e.jsx(R,{onClick:O,startIcon:e.jsx(le,{}),sx:{color:t.error,"&:hover":{background:"rgba(255, 68, 102, 0.1)"}},children:"Disconnect"})]}),!p&&!b&&e.jsx(R,{onClick:B,variant:"contained",startIcon:e.jsx(w,{}),disabled:!c,sx:{background:"linear-gradient(135deg, #f97316 0%, #ea580c 100%)","&:hover":{background:"linear-gradient(135deg, #fb923c 0%, #f97316 100%)"}},children:"Connect"})]})]}),v&&e.jsx(ne,{severity:"error",onClose:()=>d(null),sx:{mb:2},children:v}),e.jsxs(l,{ref:C,sx:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:t.background.dark,borderRadius:"12px",border:`1px solid ${t.border.light}`,overflow:"hidden",position:"relative",minHeight:400},children:[b&&e.jsxs(l,{sx:{textAlign:"center"},children:[e.jsx(te,{sx:{color:t.primary,mb:2}}),e.jsx(a,{sx:{color:t.text.secondary},children:"Starting remote desktop session..."}),e.jsxs(a,{sx:{color:t.text.disabled,fontSize:"0.85rem",mt:1},children:["Starting x11vnc on ",c?.name]})]}),!b&&!p&&!v&&e.jsxs(l,{sx:{textAlign:"center",p:4},children:[e.jsx(w,{sx:{fontSize:80,color:t.text.disabled,mb:2}}),e.jsx(a,{sx:{color:t.text.secondary,mb:1},children:"Remote Desktop"}),e.jsxs(a,{sx:{color:t.text.disabled,fontSize:"0.9rem",mb:3,maxWidth:400},children:["Connect to view and control the desktop of ",c?.name||"this machine",". This requires x11vnc to be installed on the target machine."]}),e.jsx(R,{onClick:B,variant:"contained",size:"large",startIcon:e.jsx(w,{}),disabled:!c,sx:{background:"linear-gradient(135deg, #f97316 0%, #ea580c 100%)","&:hover":{background:"linear-gradient(135deg, #fb923c 0%, #f97316 100%)"},px:4,py:1.5},children:"Start Session"})]}),(p||b)&&e.jsx(l,{ref:g,sx:{width:"100%",height:"100%",display:p?"block":"none","& canvas":{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}}}),p&&S&&!n.current&&e.jsxs(l,{sx:{textAlign:"center",p:4},children:[e.jsx(a,{sx:{color:t.secondary,fontWeight:600,mb:2},children:"VNC Server Running"}),e.jsxs(a,{sx:{color:t.text.secondary,mb:2},children:["x11vnc is running on ",c?.name,". You can connect using any VNC client:"]}),e.jsx(l,{sx:{background:"rgba(255,255,255,0.05)",borderRadius:"8px",p:2,fontFamily:"monospace"},children:e.jsxs(a,{sx:{color:t.primary},children:[c?.ip,":",S.vnc_port]})}),e.jsxs(a,{sx:{color:t.text.disabled,fontSize:"0.85rem",mt:2},children:["Display: ",S.display]})]})]})]})};export{ge as default};
